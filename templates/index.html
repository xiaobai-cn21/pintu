<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="email=no">
    <meta name="format-detection" content="address=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#20223A">
    <title>拼图大师 - 主界面</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
{% include '_navbar.html' %}
<div class="container" style="max-width: 800px; margin: 0 auto; text-align: center;">
    <div class="background-blur"></div>
    <div class="content">
        <div class="logo" style="margin: 60px 0 60px;">
            <h1 class="main-title"><span class="english-text">Puzzle</span> <span class="english-text">Master</span></h1>

            <p class="chinese-text main-subtitle">拼出你的专属世界</p>
        </div>
        <div class="menu-btns" style="display: flex; flex-direction: column; gap: 16px; max-width: 300px; margin: 0 auto;">
            <button id="loginBtn" class="btn btn-primary"><span class="chinese-text">登录</span><span class="symbol-text"> / </span><span class="chinese-text">注册</span></button>
            <a class="btn btn-default" href="{{ url_for('option_page') }}"><span class="chinese-text">开始游戏</span></a>
            <button id="helpBtn" class="btn btn-default"><span class="chinese-text">帮助中心</span></button>
            <a id="createPuzzleBtn" class="btn btn-default" style="display: none;" href="{{ url_for('editor_page') }}"><span class="chinese-text">创建拼图</span></a>
            <a id="rankBtn" class="btn btn-default" style="display: none;" href="{{ url_for('rank_page') }}"><span class="chinese-text">排行榜</span></a>
            <a id="versusBtn" class="btn btn-default" style="display: none;" href="{{ url_for('versus_page') }}"><span class="chinese-text">房间对战</span></a>
            <a id="myPuzzleBtn" class="btn btn-default" style="display: none;" href="{{ url_for('my_puzzle_page') }}"><span class="chinese-text">我的拼图</span></a>
            <a id="shareBtn" class="btn btn-default" style="display: none;" href="{{ url_for('share_page') }}"><span class="chinese-text">分享中心</span></a>
            <a id="aiBtnHome" class="btn btn-default" style="display: none;" href="{{ url_for('ai_page') }}"><span class="english-text">AI</span> <span class="chinese-text">生成</span></a>
        </div>
        <div class="copyright" style="position: fixed; bottom: 20px; left: 0; width: 100%; text-align: center; font-size: 12px; color: #999999;">
            © 2025 拼图大师 版权所有
        </div>
    </div>

    <div class="modal-mask" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="modalTitle">登录</span>
                <span class="modal-close" onclick="document.getElementById('loginModal').style.display='none'">×</span>
            </div>
            <div class="modal-body">
                <div class="tab-switch" style="display: flex; margin-bottom: 16px; border: 2px solid #F9E078; border-radius: 0;">
                    <span class="tab-item active" style="flex: 1; text-align: center; padding: 8px; cursor: pointer; background: #F9E078; color: #20223A; font-weight: bold;" onclick="switchTab('login')">登录</span>
                    <span class="tab-item" style="flex: 1; text-align: center; padding: 8px; cursor: pointer; color: #B8BCC8; background: transparent;" onclick="switchTab('register')">注册</span>
                </div>
                <form id="loginForm">
                    <div class="input-item">
                        <label>用户名<span class="symbol-text"> / </span>邮箱</label>
                        <input type="text" id="loginAccount" placeholder="请输入用户名或邮箱">
                        <div class="error-tip" id="loginAccountError">请输入正确的用户名或邮箱</div>
                    </div>
                    <div class="input-item">
                        <label>密码</label>
                        <input type="password" id="loginPwd" placeholder="请输入密码">
                        <div class="error-tip" id="loginPwdError">密码错误</div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <label style="display: flex; align-items: center; gap: 6px; font-size: 14px; color: #B8BCC8;">
                            <input type="checkbox" id="rememberMe" style="width: 16px; height: 16px; margin: 0;"> 记住我<span class="symbol-text">（</span><span class="number-text">30</span>天<span class="symbol-text">）</span>
                        </label>
                        <span style="font-size: 14px; color: #B8BCC8; cursor: pointer;">忘记密码？</span>
                    </div>
                </form>
                <form id="registerForm" style="display: none;">
                    <div class="input-item">
                        <label>用户名<span class="symbol-text">（</span><span class="number-text">4</span><span class="symbol-text">-</span><span class="number-text">16</span>位，含字母<span class="symbol-text">/</span>数字<span class="symbol-text">/</span>下划线<span class="symbol-text">）</span></label>
                        <input type="text" id="regUsername" placeholder="请输入用户名">
                        <div class="error-tip" id="regUsernameError">用户名格式错误或已存在</div>
                    </div>
                    <div class="input-item">
                        <label>邮箱</label>
                        <input type="email" id="regEmail" placeholder="请输入邮箱">
                        <div class="error-tip" id="regEmailError">邮箱格式错误或已存在</div>
                    </div>
                    <div class="input-item">
                        <label>密码<span class="symbol-text">（</span><span class="number-text">8</span><span class="symbol-text">-</span><span class="number-text">20</span>位，含大小写<span class="symbol-text">/</span>数字<span class="symbol-text">/</span>特殊符号<span class="symbol-text">）</span></label>
                        <input type="password" id="regPwd" placeholder="请输入密码">
                        <div class="error-tip" id="regPwdError">密码格式不符合要求</div>
                    </div>
                    <div class="input-item">
                        <label>确认密码</label>
                        <input type="password" id="regPwdConfirm" placeholder="请再次输入密码">
                        <div class="error-tip" id="regPwdConfirmError">两次密码不一致</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default" onclick="document.getElementById('loginModal').style.display='none'">取消</button>
                <button id="submitLogin" class="btn btn-primary">登录</button>
                <button id="submitRegister" class="btn btn-primary" style="display: none;">注册</button>
            </div>
        </div>
    </div>

    <div class="modal-mask" id="helpModal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <span>操作指南</span>
                <span class="modal-close" onclick="document.getElementById('helpModal').style.display='none'">×</span>
            </div>
            <div class="modal-body" style="font-size: 14px; line-height: 24px; color: #E0E0E0;">
                <p><strong style="color: #F9E078;">1. 游戏操作</strong></p>
                <p>- 鼠标左键长按图块，拖拽到拼图区域</p>
                <p>- 单击选中的图块，顺时针旋转90度</p>
                <p>- 点击"撤销"可还原上一步操作，"重做"恢复撤销操作</p>
                <p><strong style="color: #F9E078; margin-top: 16px; display: block;">2. 自定义拼图</strong></p>
                <p>- 支持上传本地图片（JPG/PNG，最大5MB），可裁剪调整</p>
                <p>- 可设置拼图块数（4-64块）、形状（矩形/异形）、是否旋转</p>
                <p><strong style="color: #F9E078; margin-top: 16px; display: block;">3. 存档与分享</strong></p>
                <p>- 登录用户存档同步至服务器，游客存档仅保存在当前浏览器</p>
                <p>- 自定义拼图可分享至"分享中心"，供其他玩家游玩</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="document.getElementById('helpModal').style.display='none'">我知道了</button>
            </div>
        </div>
    </div>
</div>

<script>
function switchTab(type){
    const loginForm=document.getElementById('loginForm');
    const registerForm=document.getElementById('registerForm');
    const loginBtnEl=document.getElementById('submitLogin');
    const registerBtnEl=document.getElementById('submitRegister');
    const modalTitle=document.getElementById('modalTitle');
    const tabItems=document.querySelectorAll('.tab-item');
    if(type==='login'){
        loginForm.style.display='block';
        registerForm.style.display='none';
        loginBtnEl.style.display='block';
        registerBtnEl.style.display='none';
        modalTitle.textContent='登录';
        tabItems[0].classList.add('active');
        tabItems[0].style.background='#F9E078';
        tabItems[0].style.color='#20223A';
        tabItems[0].style.fontWeight='bold';
        tabItems[1].classList.remove('active');
        tabItems[1].style.background='transparent';
        tabItems[1].style.color='#B8BCC8';
        tabItems[1].style.fontWeight='normal';
    }else{
        loginForm.style.display='none';
        registerForm.style.display='block';
        loginBtnEl.style.display='none';
        registerBtnEl.style.display='block';
        modalTitle.textContent='注册';
        tabItems[1].classList.add('active');
        tabItems[1].style.background='#F9E078';
        tabItems[1].style.color='#20223A';
        tabItems[1].style.fontWeight='bold';
        tabItems[0].classList.remove('active');
        tabItems[0].style.background='transparent';
        tabItems[0].style.color='#B8BCC8';
        tabItems[0].style.fontWeight='normal';
    }
}
document.getElementById('loginBtn').addEventListener('click',()=>{document.getElementById('loginModal').style.display='flex'});
document.getElementById('helpBtn').addEventListener('click',()=>{document.getElementById('helpModal').style.display='flex'});
window.onload=function(){
  const token=localStorage.getItem('puzzleToken');
  if(token){
    document.getElementById('loginBtn').style.display='none';
    document.getElementById('createPuzzleBtn').style.display='block';
    document.getElementById('rankBtn').style.display='block';
    document.getElementById('versusBtn').style.display='block';
    document.getElementById('myPuzzleBtn').style.display='block';
    document.getElementById('shareBtn').style.display='block';
    const aiBtn=document.getElementById('aiBtnHome'); if(aiBtn) aiBtn.style.display='block';
  }
}
// 测试登录代码已移除，使用真实登录
</script>
<script>
// 真实登录
async function realLogin(){
  const loginKey=document.getElementById('loginAccount').value.trim();
  const password=document.getElementById('loginPwd').value.trim();
  const res=await fetch('/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({loginKey,password})});
  const json=await res.json();
  if(json.code===200&&json.data){
    localStorage.setItem('puzzleToken', json.data.token);
    localStorage.setItem('userId', json.data.userId);
    window.location.reload();
  }else{ alert(json.message||'登录失败'); }
}
document.getElementById('submitLogin').onclick=realLogin;

// 真实注册
async function realRegister(){
  const username=document.getElementById('regUsername').value.trim();
  const email=document.getElementById('regEmail').value.trim();
  const password=document.getElementById('regPwd').value.trim();
  const confirmPassword=document.getElementById('regPwdConfirm').value.trim();
  const res=await fetch('/auth/signin',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,email,password,confirmPassword})});
  const json=await res.json();
  if(json.code==200){ alert('注册成功，请登录'); switchTab('login'); }
  else{ alert(json.message||'注册失败'); }
}
document.getElementById('submitRegister').onclick=realRegister;
</script>
    <!-- 页面特定的背景音乐 -->
    <script>
        // 等待音乐管理器加载完成
        function initPageMusic() {
            if (window.musicManager) {
                // 主界面自动播放主界面音乐
                window.musicManager.playScene('main');
            } else {
                // 如果音乐管理器尚未加载，稍后重试
                setTimeout(initPageMusic, 100);
            }
        }
        
        // 页面加载完成后直接初始化音乐，无需等待用户交互
        document.addEventListener('DOMContentLoaded', function() {
            // 直接尝试播放音乐
            initPageMusic();
        });
    </script>
</body>
</html>


