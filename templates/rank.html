<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>拼图排行榜</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/game-rank.css') }}">
    <style>
        .rank-container { max-width: 1000px; margin: 80px auto 20px; padding: 20px; background: #20223A; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,.3); }
        .rank-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #F9E078; }
        .back-btn { background-color: #F9E078; color: #20223A; border: none; padding: 8px 16px; border-radius: 0; cursor: pointer; text-decoration: none; display: inline-block; font-family: 'Press Start 2P', 'Zpix', monospace; font-size: 12px; }
        .back-btn:hover { background-color: #E6D166; }
        .rank-title { font-weight: bold; color: #F9E078; margin: 0; font-family: 'Press Start 2P', 'Zpix', monospace; font-size: 18px; }
        .refresh-btn { background: #F9E078; color: #20223A; border: none; cursor: pointer; font-size: 12px; padding: 8px 16px; border-radius: 0; font-family: 'Press Start 2P', 'Zpix', monospace; }
        .my-rank-card { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; padding:20px; border-radius:10px; margin-bottom:20px; box-shadow:0 4px 15px rgba(102,126,234,.3); }
        .my-rank-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; }
        .my-rank-title::before { content: "👤"; margin-right: 8px; }
        .my-rank-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; }
        .my-rank-item { text-align: center; }
        .my-rank-label { font-size: 12px; opacity: .8; margin-bottom: 5px; }
        .my-rank-value { font-size: 20px; font-weight: bold; }
        .rank-table { width: 100%; border-collapse: collapse; background: #20223A; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,.25); }
        .rank-table th { background: #2a2c4a; color:#F9E078; padding: 15px; text-align: center; font-weight: bold; font-size: 18px; }
        .rank-table td { padding: 16px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.08); font-size: 16px; color:#F9E078; }
        .rank-table tr:hover { background-color: rgba(255,255,255,0.04); }
        .rank-number { font-weight: bold; font-size: 20px; }
        .rank-number.top3 { font-size: 22px; }
        .rank-number.rank-1 { color: #ffd700; }
        .rank-number.rank-2 { color: #c0c0c0; }
        .rank-number.rank-3 { color: #cd7f32; }
        .player-name { font-weight: 500; }
        .player-name.top3 { font-weight: bold; }
        .time-display { font-family: 'Courier New', monospace; font-weight: 500; }
        .time-display.top3 { font-weight: bold; }
        .steps-display { font-weight: 500; }
        .steps-display.top3 { font-weight: bold; }
        .levels-display { font-weight: 500; }
        .levels-display.top3 { font-weight: bold; }
        .loading-message,.error-message,.empty-message { text-align:center; padding:40px; font-size:18px; }
        .error-message { color:#e74c3c; }
        @media (max-width: 768px) {
            .rank-container { margin:10px; padding:15px; }
            .rank-header { flex-direction: column; gap: 15px; text-align: center; }
            .rank-title { font-size: 28px; }
            .rank-table th { font-size: 14px; padding: 10px 5px; }
            .rank-table td { font-size: 14px; padding: 10px 5px; }
        }
        @media (max-width: 480px) {
            .rank-table th { font-size: 12px; }
            .rank-table td { font-size: 12px; }
            .my-rank-info { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    {% include '_navbar.html' %}
    <div class="background-blur"></div>
    <div class="rank-container">
        <div class="rank-header">
            <button class="btn btn-secondary back-btn" onclick="window.location.href='{{ url_for('main') }}'" style="padding: 8px 16px; font-size: 12px;">
                <span class="chinese-text">返回主界面</span>
            </button>
            <h1 class="rank-title chinese-text">拼图排行榜</h1>
            <button id="refreshBtn" class="btn refresh-btn" title="刷新数据" style="padding: 8px 16px; font-size: 12px;">
                <span class="chinese-text">刷新</span>
            </button>
        </div>
        <div id="myRankCard" class="my-rank-card" style="display:none;">
            <div class="my-rank-title">我的成绩</div>
            <div class="my-rank-info">
                <div class="my-rank-item"><div class="my-rank-label">排名</div><div class="my-rank-value" id="myRank">-</div></div>
                <div class="my-rank-item"><div class="my-rank-label">总时长</div><div class="my-rank-value" id="myTotalTime">00:00:00</div></div>
                <div class="my-rank-item"><div class="my-rank-label">总步数</div><div class="my-rank-value" id="myTotalSteps">0</div></div>
                <div class="my-rank-item"><div class="my-rank-label">通过关卡数</div><div class="my-rank-value" id="myPassedLevels">0</div></div>
            </div>
        </div>
        <div id="rankTableContainer">
            <table class="rank-table">
                <thead>
                    <tr>
                        <th>排名</th>
                        <th>玩家</th>
                        <th>游戏总时长</th>
                        <th>总步数</th>
                        <th>通过关卡数</th>
                    </tr>
                </thead>
                <tbody id="rankTableBody"></tbody>
            </table>
        </div>
        <div id="loadingMessage" class="loading-message" style="display:none;">正在加载排行榜数据...</div>
        <div id="errorMessage" class="error-message" style="display:none;">❌ 加载失败，请稍后重试</div>
        <div id="emptyMessage" class="empty-message" style="display:none;">暂无排行榜数据</div>
    </div>
    <script>
        class RankPage {
            constructor(){
                this.refreshBtn=document.getElementById('refreshBtn');
                this.myRankCard=document.getElementById('myRankCard');
                this.rankTableBody=document.getElementById('rankTableBody');
                this.loadingMessage=document.getElementById('loadingMessage');
                this.errorMessage=document.getElementById('errorMessage');
                this.emptyMessage=document.getElementById('emptyMessage');
                this.rankTableContainer=document.getElementById('rankTableContainer');
                this.useMock=new URLSearchParams(location.search).get('mock')==='1';
                this.bindEvents();
                this.loadRankData();
            }
            bindEvents(){ this.refreshBtn.addEventListener('click',()=>this.loadRankData()); }
            async loadRankData(){
                this.showLoading();
                try{
                    const response=await this.fetchRankData();
                    if(response.success){ this.displayRankData(response.data); }
                    else{ this.showError(); }
                }catch(e){ console.error(e); this.showError(); }
            }
            async fetchRankData(){
                try{
                    if(this.useMock){
                        // 模拟数据添加通过关卡数
                        const mock=[
                            { playerName:'test1', totalTime:5400, totalSteps:200, passedLevels:5 },
                            { playerName:'test2', totalTime:7200, totalSteps:188, passedLevels:7 },
                            { playerName:'test3', totalTime:7200, totalSteps:190, passedLevels:6 },
                            { playerName:'test4', totalTime:3600, totalSteps:120, passedLevels:3 },
                            { playerName:'admin', totalTime:6100, totalSteps:175, passedLevels:4 },
                            { playerName:'test5', totalTime:6100, totalSteps:180, passedLevels:5 },
                            { playerName:'test6', totalTime:1200, totalSteps:90, passedLevels:2 }
                        ];
                        // 排序规则：总时长降序 → 总步数升序 → 过关数降序
                        mock.sort((a,b)=>{ 
                            if(b.totalTime!==a.totalTime) return b.totalTime-a.totalTime;
                            if(a.totalSteps!==b.totalSteps) return a.totalSteps-b.totalSteps;
                            return b.passedLevels - a.passedLevels;
                        });
                        mock.forEach((p,i)=>p.rank=i+1);
                        return { success:true, data:{ rankList: mock } };
                    }
                    const res=await fetch('/ranking/',{ credentials:'include' });
                    if(!res.ok) return { success:false };
                    const json=await res.json();
                    if(json.code!==200||!Array.isArray(json.data)) return { success:false };
                    // 从接口数据映射所需字段，包含过关数
                    const rankList=json.data.map((r,i)=>({ 
                        rank:i+1, 
                        playerName:r.username, 
                        totalTime:Number(r.time_used)||0, 
                        totalSteps:Number(r.step_count)||0,
                        passedLevels:Number(r.passed_levels)||0  // 新增：通过关卡数
                    }));
                    return { success:true, data:{ rankList } };
                }catch(e){ return { success:false }; }
            }
            displayRankData(data){
                this.hideAll();
                // 排序规则：总时长降序 → 总步数升序 → 过关数降序
                const sorted=[...data.rankList].sort((a,b)=>{ 
                    if(b.totalTime!==a.totalTime) return b.totalTime-a.totalTime;
                    if(a.totalSteps!==b.totalSteps) return a.totalSteps-b.totalSteps;
                    return b.passedLevels - a.passedLevels;
                });
                sorted.forEach((p,idx)=>p.rank=idx+1);
                
                const currentName=localStorage.getItem('username')||'当前用户';
                const myEntry=sorted.find(p=>p.playerName===currentName);
                if(myEntry){ 
                    this.displayMyRank({ 
                        rank:myEntry.rank, 
                        playerName:myEntry.playerName, 
                        totalTime:myEntry.totalTime, 
                        totalSteps:myEntry.totalSteps,
                        passedLevels:myEntry.passedLevels  // 传递过关数
                    }); 
                }
                
                this.displayRankList(sorted);
                this.rankTableContainer.style.display='block';
                
                // 处理空数据情况
                if(sorted.length === 0){
                    this.showEmpty();
                }
            }
            displayMyRank(m){
                document.getElementById('myRank').textContent=m.rank;
                document.getElementById('myTotalTime').textContent=this.formatTime(m.totalTime);
                document.getElementById('myTotalSteps').textContent=m.totalSteps;
                document.getElementById('myPassedLevels').textContent=m.passedLevels;  // 显示过关数
                this.myRankCard.style.display='block';
            }
            displayRankList(list){
                this.rankTableBody.innerHTML='';
                list.forEach(p=>{
                    const isTop3=p.rank<=3;
                    const isCurrent=p.playerName==='当前用户';
                    const row=document.createElement('tr');
                    row.innerHTML=`
                        <td><span class="rank-number ${isTop3?'top3':''} ${isTop3?`rank-${p.rank}`:''}">${p.rank}</span></td>
                        <td><span class="player-name ${isTop3?'top3':''}">${p.playerName}${isCurrent?' (我)':''}</span></td>
                        <td><span class="time-display ${isTop3?'top3':''}">${this.formatTime(p.totalTime)}</span></td>
                        <td><span class="steps-display ${isTop3?'top3':''}">${p.totalSteps}</span></td>
                        <td><span class="levels-display ${isTop3?'top3':''}">${p.passedLevels}</span></td>`;  // 新增过关数列
                    this.rankTableBody.appendChild(row);
                });
            }
            formatTime(s){ 
                const h=Math.floor(s/3600), 
                      m=Math.floor((s%3600)/60), 
                      sec=s%60; 
                return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}` 
            }
            showLoading(){ this.hideAll(); this.loadingMessage.style.display='block'; this.refreshBtn.disabled=true; }
            showError(){ this.hideAll(); this.errorMessage.style.display='block'; this.refreshBtn.disabled=false; }
            showEmpty(){ this.hideAll(); this.emptyMessage.style.display='block'; this.refreshBtn.disabled=false; }
            hideAll(){ 
                this.loadingMessage.style.display='none'; 
                this.errorMessage.style.display='none'; 
                this.emptyMessage.style.display='none'; 
                this.rankTableContainer.style.display='none'; 
                this.myRankCard.style.display='none'; 
            }
        }
        document.addEventListener('DOMContentLoaded',()=>{ new RankPage(); });
    </script>

<!-- 帮助页面模态框 -->
<div class="modal-mask" id="helpModal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <span>操作指南</span>
            <span class="modal-close" onclick="document.getElementById('helpModal').style.display='none'">×</span>
        </div>
        <div class="modal-body" style="font-size: 14px; line-height: 24px; color: #E0E0E0;">
            <p><strong style="color: #F9E078;">1. 游戏操作</strong></p>
            <p>- 鼠标左键长按图块，拖拽到拼图区域</p>
            <p>- 单击选中的图块，顺时针旋转90度</p>
            <p>- 点击"撤销"可还原上一步操作，"重做"恢复撤销操作</p>
            <p><strong style="color: #F9E078; margin-top: 16px; display: block;">2. 自定义拼图</strong></p>
            <p>- 支持上传本地图片（JPG/PNG，最大5MB），可裁剪调整</p>
            <p>- 可设置拼图块数（4-64块）、形状（矩形/异形）、是否旋转</p>
            <p><strong style="color: #F9E078; margin-top: 16px; display: block;">3. 存档与分享</strong></p>
            <p>- 登录用户存档同步至服务器，游客存档仅保存在当前浏览器</p>
            <p>- 自定义拼图可分享至"分享中心"，供其他玩家游玩</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="document.getElementById('helpModal').style.display='none'">我知道了</button>
        </div>
    </div>
</div>
    <!-- 页面特定的背景音乐 -->
    <script>
        // 等待音乐管理器加载完成
        function initPageMusic() {
            if (window.musicManager) {
                // 排行榜页面自动播放主界面音乐
                window.musicManager.playScene('main');
            } else {
                // 如果音乐管理器尚未加载，稍后重试
                setTimeout(initPageMusic, 100);
            }
        }
        
        // 页面加载完成后直接初始化音乐，无需等待用户交互
        document.addEventListener('DOMContentLoaded', function() {
            // 直接尝试播放音乐
            initPageMusic();
        });
    </script>
</body>
</html>
