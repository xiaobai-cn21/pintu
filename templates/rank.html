<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="email=no">
    <meta name="format-detection" content="address=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#20223A">
    <title>æ‹¼å›¾æ’è¡Œæ¦œ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/game-rank.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mobile.css') }}">
    <style>
        .rank-container { max-width: 1000px; margin: 80px auto 20px; padding: 20px; background: #20223A; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,.3); }
        .rank-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #F9E078; }
        .back-btn { background-color: #F9E078; color: #20223A; border: none; padding: 8px 16px; border-radius: 0; cursor: pointer; text-decoration: none; display: inline-block; font-family: 'Press Start 2P', 'Zpix', monospace; font-size: 12px; }
        .back-btn:hover { background-color: #E6D166; }
        .rank-title { font-weight: bold; color: #F9E078; margin: 0; font-family: 'Press Start 2P', 'Zpix', monospace; font-size: 18px; }
        .refresh-btn { background: #F9E078; color: #20223A; border: none; cursor: pointer; font-size: 12px; padding: 8px 16px; border-radius: 0; font-family: 'Press Start 2P', 'Zpix', monospace; }
        .my-rank-card { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; padding:20px; border-radius:10px; margin-bottom:20px; box-shadow:0 4px 15px rgba(102,126,234,.3); }
        .my-rank-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; }
        .my-rank-title::before { content: "ğŸ‘¤"; margin-right: 8px; }
        .my-rank-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .my-rank-item { text-align: center; }
        .my-rank-label { font-size: 12px; opacity: .8; margin-bottom: 5px; }
        .my-rank-value { font-size: 20px; font-weight: bold; }
        .rank-table { width: 100%; border-collapse: collapse; background: #20223A; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,.25); }
        .rank-table th { background: #2a2c4a; color:#F9E078; padding: 15px; text-align: center; font-weight: bold; font-size: 18px; }
        .rank-table td { padding: 16px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.08); font-size: 16px; color:#F9E078; }
        .rank-table tr:hover { background-color: rgba(255,255,255,0.04); }
        .rank-number { font-weight: bold; font-size: 20px; }
        .rank-number.top3 { font-size: 22px; }
        .rank-number.rank-1 { color: #ffd700; }
        .rank-number.rank-2 { color: #c0c0c0; }
        .rank-number.rank-3 { color: #cd7f32; }
        .player-name { font-weight: 500; }
        .player-name.top3 { font-weight: bold; }
        .time-display { font-family: 'Courier New', monospace; font-weight: 500; }
        .time-display.top3 { font-weight: bold; }
        .steps-display { font-weight: 500; }
        .steps-display.top3 { font-weight: bold; }
        .loading-message,.error-message,.empty-message { text-align:center; padding:40px; font-size:18px; }
        .error-message { color:#e74c3c; }
        @media (max-width: 768px) {
            .rank-container { margin:10px; padding:15px; }
            .rank-header { flex-direction: column; gap: 15px; text-align: center; }
            .rank-title { font-size: 28px; }
            .rank-table th { font-size: 16px; }
            .rank-table td { font-size: 15px; padding: 12px 6px; }
        }
        @media (max-width: 480px) {
            .rank-table th { font-size: 14px; }
            .rank-table td { font-size: 14px; padding: 10px 4px; }
            .my-rank-info { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    {% include '_navbar.html' %}
    <div class="background-blur"></div>
    <div class="rank-container">
        <div class="rank-header">
            <button class="btn btn-secondary back-btn" onclick="window.location.href='{{ url_for('main') }}'" style="padding: 8px 16px; font-size: 12px;">
                <span class="chinese-text">è¿”å›ä¸»ç•Œé¢</span>
            </button>
            <h1 class="rank-title chinese-text">æ‹¼å›¾æ’è¡Œæ¦œ</h1>
            <button id="refreshBtn" class="btn refresh-btn" title="åˆ·æ–°æ•°æ®" style="padding: 8px 16px; font-size: 12px;">
                <span class="chinese-text">åˆ·æ–°</span>
            </button>
        </div>
        <div id="myRankCard" class="my-rank-card" style="display:none;">
            <div class="my-rank-title">æˆ‘çš„æˆç»©</div>
            <div class="my-rank-info">
                <div class="my-rank-item"><div class="my-rank-label">æ’å</div><div class="my-rank-value" id="myRank">-</div></div>
                <div class="my-rank-item"><div class="my-rank-label">æ€»æ—¶é•¿</div><div class="my-rank-value" id="myTotalTime">00:00:00</div></div>
                <div class="my-rank-item"><div class="my-rank-label">æ€»æ­¥æ•°</div><div class="my-rank-value" id="myTotalSteps">0</div></div>
            </div>
        </div>
        <div id="rankTableContainer">
            <table class="rank-table">
                <thead><tr><th>æ’å</th><th>ç©å®¶</th><th>æ¸¸æˆæ€»æ—¶é•¿</th><th>æ€»æ­¥æ•°</th></tr></thead>
                <tbody id="rankTableBody"></tbody>
            </table>
        </div>
        <div id="loadingMessage" class="loading-message" style="display:none;">æ­£åœ¨åŠ è½½æ’è¡Œæ¦œæ•°æ®...</div>
        <div id="errorMessage" class="error-message" style="display:none;">âŒ åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>
        <div id="emptyMessage" class="empty-message" style="display:none;">æš‚æ— æ’è¡Œæ¦œæ•°æ®</div>
    </div>
    <script>
        class RankPage {
            constructor(){
                this.refreshBtn=document.getElementById('refreshBtn');
                this.myRankCard=document.getElementById('myRankCard');
                this.rankTableBody=document.getElementById('rankTableBody');
                this.loadingMessage=document.getElementById('loadingMessage');
                this.errorMessage=document.getElementById('errorMessage');
                this.emptyMessage=document.getElementById('emptyMessage');
                this.rankTableContainer=document.getElementById('rankTableContainer');
                this.useMock=new URLSearchParams(location.search).get('mock')==='1';
                this.bindEvents();
                this.loadRankData();
            }
            bindEvents(){ this.refreshBtn.addEventListener('click',()=>this.loadRankData()); }
            async loadRankData(){
                this.showLoading();
                try{
                    const response=await this.fetchRankData();
                    if(response.success){ this.displayRankData(response.data); }
                    else{ this.showError(); }
                }catch(e){ console.error(e); this.showError(); }
            }
            async fetchRankData(){
                try{
                    if(this.useMock){
                        const mock=[
                            { playerName:'test1', totalTime:5400, totalSteps:200 },
                            { playerName:'test2', totalTime:7200, totalSteps:188 },
                            { playerName:'test3', totalTime:7200, totalSteps:190 },
                            { playerName:'test4', totalTime:3600, totalSteps:120 },
                            { playerName:'admin', totalTime:6100, totalSteps:175 },
                            { playerName:'test5', totalTime:6100, totalSteps:180 },
                            { playerName:'test6', totalTime:1200, totalSteps:90 }
                        ];
                        mock.sort((a,b)=>(b.totalTime-a.totalTime)||(a.totalSteps-b.totalSteps));
                        mock.forEach((p,i)=>p.rank=i+1);
                        const my=null;
                        return { success:true, data:{ myRank: my, rankList: mock } };
                    }
                    const res=await fetch('/ranking/',{ credentials:'include' });
                    if(!res.ok) return { success:false };
                    const json=await res.json();
                    if(json.code!==200||!Array.isArray(json.data)) return { success:false };
                    const rankList=json.data.map((r,i)=>({ rank:i+1, playerName:r.username, totalTime:Number(r.time_used)||0, totalSteps:Number(r.step_count)||0 }));
                    return { success:true, data:{ myRank:null, rankList } };
                }catch(e){ return { success:false }; }
            }
            displayRankData(data){
                this.hideAll();
                const sorted=[...data.rankList].sort((a,b)=>{ if(b.totalTime!==a.totalTime) return b.totalTime-a.totalTime; return a.totalSteps-b.totalSteps; });
                sorted.forEach((p,idx)=>p.rank=idx+1);
                const currentName=localStorage.getItem('username')||'å½“å‰ç”¨æˆ·';
                const myEntry=sorted.find(p=>p.playerName===currentName);
                if(myEntry){ this.displayMyRank({ rank:myEntry.rank, playerName:myEntry.playerName, totalTime:myEntry.totalTime, totalSteps:myEntry.totalSteps }); }
                this.displayRankList(sorted);
                this.rankTableContainer.style.display='block';
            }
            displayMyRank(m){
                document.getElementById('myRank').textContent=m.rank;
                document.getElementById('myTotalTime').textContent=this.formatTime(m.totalTime);
                document.getElementById('myTotalSteps').textContent=m.totalSteps;
                this.myRankCard.style.display='block';
            }
            displayRankList(list){
                this.rankTableBody.innerHTML='';
                list.forEach(p=>{
                    const isTop3=p.rank<=3;
                    const isCurrent=p.playerName==='å½“å‰ç”¨æˆ·';
                    const row=document.createElement('tr');
                    row.innerHTML=`
                        <td><span class="rank-number ${isTop3?'top3':''} ${isTop3?`rank-${p.rank}`:''}">${p.rank}</span></td>
                        <td><span class="player-name ${isTop3?'top3':''}">${p.playerName}${isCurrent?' (æˆ‘)':''}</span></td>
                        <td><span class="time-display ${isTop3?'top3':''}">${this.formatTime(p.totalTime)}</span></td>
                        <td><span class="steps-display ${isTop3?'top3':''}">${p.totalSteps}</span></td>`;
                    this.rankTableBody.appendChild(row);
                });
            }
            formatTime(s){ const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=s%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}` }
            showLoading(){ this.hideAll(); this.loadingMessage.style.display='block'; this.refreshBtn.disabled=true; }
            showError(){ this.hideAll(); this.errorMessage.style.display='block'; this.refreshBtn.disabled=false; }
            showEmpty(){ this.hideAll(); this.emptyMessage.style.display='block'; this.refreshBtn.disabled=false; }
            hideAll(){ this.loadingMessage.style.display='none'; this.errorMessage.style.display='none'; this.emptyMessage.style.display='none'; this.rankTableContainer.style.display='none'; this.myRankCard.style.display='none'; }
        }
        document.addEventListener('DOMContentLoaded',()=>{ new RankPage(); });
    </script>

<!-- å¸®åŠ©é¡µé¢æ¨¡æ€æ¡† -->
<div class="modal-mask" id="helpModal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <span>æ“ä½œæŒ‡å—</span>
            <span class="modal-close" onclick="document.getElementById('helpModal').style.display='none'">Ã—</span>
        </div>
        <div class="modal-body" style="font-size: 14px; line-height: 24px; color: #E0E0E0;">
            <p><strong style="color: #F9E078;">1. æ¸¸æˆæ“ä½œ</strong></p>
            <p>- é¼ æ ‡å·¦é”®é•¿æŒ‰å›¾å—ï¼Œæ‹–æ‹½åˆ°æ‹¼å›¾åŒºåŸŸ</p>
            <p>- å•å‡»é€‰ä¸­çš„å›¾å—ï¼Œé¡ºæ—¶é’ˆæ—‹è½¬90åº¦</p>
            <p>- ç‚¹å‡»"æ’¤é”€"å¯è¿˜åŸä¸Šä¸€æ­¥æ“ä½œï¼Œ"é‡åš"æ¢å¤æ’¤é”€æ“ä½œ</p>
            <p><strong style="color: #F9E078; margin-top: 16px; display: block;">2. è‡ªå®šä¹‰æ‹¼å›¾</strong></p>
            <p>- æ”¯æŒä¸Šä¼ æœ¬åœ°å›¾ç‰‡ï¼ˆJPG/PNGï¼Œæœ€å¤§5MBï¼‰ï¼Œå¯è£å‰ªè°ƒæ•´</p>
            <p>- å¯è®¾ç½®æ‹¼å›¾å—æ•°ï¼ˆ4-64å—ï¼‰ã€å½¢çŠ¶ï¼ˆçŸ©å½¢/å¼‚å½¢ï¼‰ã€æ˜¯å¦æ—‹è½¬</p>
            <p><strong style="color: #F9E078; margin-top: 16px; display: block;">3. å­˜æ¡£ä¸åˆ†äº«</strong></p>
            <p>- ç™»å½•ç”¨æˆ·å­˜æ¡£åŒæ­¥è‡³æœåŠ¡å™¨ï¼Œæ¸¸å®¢å­˜æ¡£ä»…ä¿å­˜åœ¨å½“å‰æµè§ˆå™¨</p>
            <p>- è‡ªå®šä¹‰æ‹¼å›¾å¯åˆ†äº«è‡³"åˆ†äº«ä¸­å¿ƒ"ï¼Œä¾›å…¶ä»–ç©å®¶æ¸¸ç©</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="document.getElementById('helpModal').style.display='none'">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>
</div>
    <!-- é¡µé¢ç‰¹å®šçš„èƒŒæ™¯éŸ³ä¹ -->
    <script>
        // ç­‰å¾…éŸ³ä¹ç®¡ç†å™¨åŠ è½½å®Œæˆ
        function initPageMusic() {
            if (window.musicManager) {
                // æ’è¡Œæ¦œé¡µé¢è‡ªåŠ¨æ’­æ”¾ä¸»ç•Œé¢éŸ³ä¹
                window.musicManager.playScene('main');
            } else {
                // å¦‚æœéŸ³ä¹ç®¡ç†å™¨å°šæœªåŠ è½½ï¼Œç¨åé‡è¯•
                setTimeout(initPageMusic, 100);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåç›´æ¥åˆå§‹åŒ–éŸ³ä¹ï¼Œæ— éœ€ç­‰å¾…ç”¨æˆ·äº¤äº’
        document.addEventListener('DOMContentLoaded', function() {
            // ç›´æ¥å°è¯•æ’­æ”¾éŸ³ä¹
            initPageMusic();
        });
    </script>

<script>
// ç§»åŠ¨ç«¯è®¾å¤‡æ£€æµ‹å’Œç±»æ·»åŠ 
(function() {
    'use strict';
    
    function isMobile() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
               window.innerWidth <= 768;
    }
    
    function addMobileClass() {
        if (isMobile()) {
            document.body.classList.add('mobile-device');
        }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', addMobileClass);
    } else {
        addMobileClass();
    }
    
    // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°æ£€æµ‹
    window.addEventListener('resize', function() {
        setTimeout(addMobileClass, 100);
    });
})();
</script>

</body>
</html>


