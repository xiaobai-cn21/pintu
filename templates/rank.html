<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹¼å›¾æ’è¡Œæ¦œ</title>
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        /* æ’è¡Œæ¦œä¸“ç”¨æ ·å¼ */
        .rank-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .rank-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .back-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .back-btn:hover {
            background-color: #2980b9;
        }

        .rank-title {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
            margin: 0;
        }

        .refresh-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: #3498db;
            transition: transform 0.3s;
            padding: 10px;
        }

        .refresh-btn:hover {
            transform: rotate(180deg);
        }

        /* å–æ¶ˆåˆ·æ–°æŒ‰é’®çš„â€œåˆ·æ–°ä¸­â€æ—‹è½¬åŠ¨ç”»çŠ¶æ€ */

        .my-rank-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .my-rank-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .my-rank-title::before {
            content: "ğŸ‘¤";
            margin-right: 8px;
        }

        .my-rank-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .my-rank-item {
            text-align: center;
        }

        .my-rank-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .my-rank-value {
            font-size: 20px;
            font-weight: bold;
        }

        .rank-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .rank-table th {
            background: linear-gradient(135deg, #FFE082 0%, #FFC107 100%);
            color: #4a3b00;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
        }

        .rank-table td {
            padding: 16px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
            transition: background-color 0.3s;
            font-size: 16px;
        }

        .rank-table tr:hover {
            background-color: #f8f9fa;
        }

        .rank-table tr:last-child td {
            border-bottom: none;
        }

        .rank-number {
            font-weight: bold;
            font-size: 20px;
        }

        .rank-number.top3 {
            font-weight: bold;
            font-size: 22px;
        }

        .rank-number.rank-1 {
            color: #ffd700;
        }

        .rank-number.rank-2 {
            color: #c0c0c0;
        }

        .rank-number.rank-3 {
            color: #cd7f32;
        }

        .player-name {
            font-weight: 500;
        }

        .player-name.top3 {
            font-weight: bold;
        }

        .time-display {
            font-family: 'Courier New', monospace;
            font-weight: 500;
        }

        .time-display.top3 {
            font-weight: bold;
        }

        .steps-display {
            font-weight: 500;
        }

        .steps-display.top3 {
            font-weight: bold;
        }

        .levels-display {
            font-weight: 500;
        }

        .levels-display.top3 {
            font-weight: bold;
        }

        .loading-message {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 18px;
        }

        .error-message {
            text-align: center;
            padding: 40px;
            color: #e74c3c;
            font-size: 18px;
        }

        .empty-message {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 18px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .rank-container {
                margin: 10px;
                padding: 15px;
            }

            .rank-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .rank-title {
                font-size: 28px;
            }

            .my-rank-info {
                grid-template-columns: repeat(2, 1fr);
            }

            .rank-table th { font-size: 16px; }
            .rank-table td { font-size: 15px; padding: 12px 6px; }
        }

        @media (max-width: 480px) {
            .rank-table th { font-size: 14px; }
            .rank-table td { font-size: 14px; padding: 10px 4px; }

            .my-rank-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="background-blur"></div>
    
    <div class="rank-container">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <div class="rank-header">
            <a href="menu.html" class="back-btn">â† è¿”å›ä¸»ç•Œé¢</a>
            <h1 class="rank-title">æ‹¼å›¾æ’è¡Œæ¦œ</h1>
            <button id="refreshBtn" class="refresh-btn" title="åˆ·æ–°æ•°æ®">ğŸ”„</button>
        </div>

        <!-- æˆ‘çš„æ’åå¡ç‰‡ï¼šæ˜¾ç¤ºå½“å‰ç™»å½•ç”¨æˆ·çš„èšåˆæˆç»©ï¼ˆæ’å/æ€»æ—¶é•¿/æ€»æ­¥æ•°ï¼‰ -->
        <div id="myRankCard" class="my-rank-card" style="display: none;">
            <div class="my-rank-title">æˆ‘çš„æˆç»©</div>
            <div class="my-rank-info">
                <div class="my-rank-item">
                    <div class="my-rank-label">æ’å</div>
                    <div class="my-rank-value" id="myRank">-</div>
                </div>
                <div class="my-rank-item">
                    <div class="my-rank-label">æ€»æ—¶é•¿</div>
                    <div class="my-rank-value" id="myTotalTime">00:00:00</div>
                </div>
                <div class="my-rank-item">
                    <div class="my-rank-label">æ€»æ­¥æ•°</div>
                    <div class="my-rank-value" id="myTotalSteps">0</div>
                </div>
            </div>
        </div>

        <!-- æ’è¡Œæ¦œè¡¨æ ¼ï¼šæ€»æ¦œï¼ˆåç«¯å·²æŒ‰æ—¶é•¿é™åº/æ­¥æ•°å‡åºï¼Œå‰ç«¯å†æ¬¡ç¨³å¦¥æ’åºï¼‰ -->
        <div id="rankTableContainer">
            <table class="rank-table">
                <thead>
                    <tr>
                        <th>æ’å</th>
                        <th>ç©å®¶</th>
                        <th>æ¸¸æˆæ€»æ—¶é•¿</th>
                        <th>æ€»æ­¥æ•°</th>
                    </tr>
                </thead>
                <tbody id="rankTableBody">
                    <!-- æ’è¡Œæ¦œæ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </tbody>
            </table>
        </div>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="loadingMessage" class="loading-message" style="display: none;">
            <div>æ­£åœ¨åŠ è½½æ’è¡Œæ¦œæ•°æ®...</div>
        </div>

        <!-- é”™è¯¯çŠ¶æ€ -->
        <div id="errorMessage" class="error-message" style="display: none;">
            <div>âŒ åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>
        </div>

        <!-- ç©ºæ•°æ®çŠ¶æ€ -->
        <div id="emptyMessage" class="empty-message" style="display: none;">
            <div>æš‚æ— æ’è¡Œæ¦œæ•°æ®</div>
        </div>
    </div>

    <script>
        class RankPage {
            constructor() {
                this.refreshBtn = document.getElementById('refreshBtn');
                this.myRankCard = document.getElementById('myRankCard');
                this.rankTableBody = document.getElementById('rankTableBody');
                this.loadingMessage = document.getElementById('loadingMessage');
                this.errorMessage = document.getElementById('errorMessage');
                this.emptyMessage = document.getElementById('emptyMessage');
                this.rankTableContainer = document.getElementById('rankTableContainer');
                // æ˜¯å¦å¯ç”¨å‰ç«¯æ¨¡æ‹Ÿæ•°æ®ï¼ˆå¸¦ä¸Š ?mock=1 å¼€å¯ï¼‰
                this.useMock = new URLSearchParams(location.search).get('mock') === '1';
                
                this.bindEvents();
                this.loadRankData();
            }

            bindEvents() {
                this.refreshBtn.addEventListener('click', () => this.loadRankData());
            }

            async loadRankData() {
                this.showLoading();
                
                try {
                    // APIè°ƒç”¨ 
                    const response = await this.fetchRankData();
                    
                    if (response.success) {
                        this.displayRankData(response.data);
                    } else {
                        this.showError();
                    }
                } catch (error) {
                    console.error('åŠ è½½æ’è¡Œæ¦œæ•°æ®å¤±è´¥:', error);
                    this.showError();
                }
            }

            // æ•°æ®è·å–ï¼šå½“ URL å¸¦ ?mock=1 æ—¶ä½¿ç”¨å†…ç½®æ¨¡æ‹Ÿæ•°æ®ï¼Œå¦åˆ™è¯·æ±‚åç«¯ API
            async fetchRankData() {
                try {
                    if (this.useMock) {
                        // å†…ç½®éƒ¨åˆ†æ¨¡æ‹Ÿæ•°æ®ï¼ˆå¯æ ¹æ®éœ€è¦å¢åˆ æ”¹ï¼‰
                        const mock = [
                            { playerName: 'test1', totalTime: 5400, totalSteps: 200 },
                            { playerName: 'test2', totalTime: 7200, totalSteps: 188 },
                            { playerName: 'test3', totalTime: 7200, totalSteps: 190 },
                            { playerName: 'test4', totalTime: 3600, totalSteps: 120 },
                            { playerName: 'admin', totalTime: 6100, totalSteps: 175 },
                            { playerName: 'test5', totalTime: 6100, totalSteps: 180 },
                            { playerName: 'test6', totalTime: 1200, totalSteps: 90 }
                        ];
                        // æŒ‰è§„åˆ™æ’åºï¼šæ€»æ—¶é•¿é™åºï¼›ç›¸åŒåˆ™æ­¥æ•°å‡åº
                        mock.sort((a, b) => (b.totalTime - a.totalTime) || (a.totalSteps - b.totalSteps));
                        mock.forEach((p, i) => p.rank = i + 1);
                        const my = mock.find(p => p.playerName === (localStorage.getItem('username') || 'å½“å‰ç”¨æˆ·')) || null;
                        const myRank = my ? { rank: my.rank, playerName: my.playerName, totalTime: my.totalTime, totalSteps: my.totalSteps } : null;
                        return { success: true, data: { myRank, rankList: mock } };
                    }
                    const res = await fetch('http://localhost:5000/ranking', { credentials: 'include' });
                    if (!res.ok) return { success: false };
                    const json = await res.json();
                    if (json.code !== 200 || !Array.isArray(json.data)) return { success: false };

                    // æ˜ å°„ä¸ºå‰ç«¯éœ€è¦çš„å­—æ®µ
                    const rankList = json.data.map((r, i) => ({
                        rank: i + 1, // å®é™…ä¼šåœ¨å‰ç«¯æ’åºåé‡æ’
                        playerName: r.username,
                        totalTime: Number(r.time_used) || 0,
                        totalSteps: Number(r.step_count) || 0,
                        // completedLevels: å·²ç§»é™¤åˆ—
                    }));

                    // è®¡ç®—â€œæˆ‘â€çš„å ä½ï¼Œå…·ä½“å€¼åœ¨ displayRankData ä¸­æŒ‰æ’åºåˆ—è¡¨æ±‚
                    const myRank = null;

                    return { success: true, data: { myRank, rankList } };
                } catch (e) {
                    return { success: false };
                }
            }

            displayRankData(data) {
                this.hideAllMessages();
                
                // å‰ç«¯å…œåº•æ’åºï¼šæ€»æ—¶é•¿é™åºï¼Œå…¶æ¬¡æ€»æ­¥æ•°å‡åº
                const sorted = [...data.rankList].sort((a, b) => {
                    if (b.totalTime !== a.totalTime) return b.totalTime - a.totalTime;
                    return a.totalSteps - b.totalSteps;
                });
                // é‡æ–°è®¡ç®—æ’ååºå·
                sorted.forEach((p, idx) => { p.rank = idx + 1; });
                
                // è®¡ç®—â€œæˆ‘â€çš„æ’åï¼ˆæŒ‰ç”¨æˆ·ååŒ¹é…ï¼›è‹¥æœªç™»å½•åˆ™é»˜è®¤â€œå½“å‰ç”¨æˆ·â€ï¼‰
                const currentName = localStorage.getItem('username') || (data.myRank && data.myRank.playerName) || 'å½“å‰ç”¨æˆ·';
                const myEntry = sorted.find(p => p.playerName === currentName);
                if (myEntry) {
                    this.displayMyRank({
                        rank: myEntry.rank,
                        playerName: myEntry.playerName,
                        totalTime: myEntry.totalTime,
                        totalSteps: myEntry.totalSteps
                    });
                } else if (data.myRank) {
                    // å›é€€ï¼šå¦‚æœåˆ—è¡¨æœªåŒ…å«è¯¥ç”¨æˆ·ï¼Œåˆ™æ˜¾ç¤ºåç«¯æä¾›çš„ä¿¡æ¯
                    this.displayMyRank({
                        rank: data.myRank.rank || '-',
                        playerName: data.myRank.playerName || currentName,
                        totalTime: data.myRank.totalTime || 0,
                        totalSteps: data.myRank.totalSteps || 0
                    });
                }
                
                // æ¸²æŸ“æ’è¡Œæ¦œ
                this.displayRankList(sorted);
                
                this.rankTableContainer.style.display = 'block';
            }

            // æ¸²æŸ“â€œæˆ‘çš„æˆç»©â€å¡ç‰‡
            displayMyRank(myRank) {
                document.getElementById('myRank').textContent = myRank.rank;
                document.getElementById('myTotalTime').textContent = this.formatTime(myRank.totalTime);
                document.getElementById('myTotalSteps').textContent = myRank.totalSteps;
                this.myRankCard.style.display = 'block';
            }

            // æ¸²æŸ“æ’è¡Œæ¦œåˆ—è¡¨
            displayRankList(rankList) {
                this.rankTableBody.innerHTML = '';
                
                rankList.forEach(player => {
                    const row = document.createElement('tr');
                    const isTop3 = player.rank <= 3;
                    const isCurrentUser = player.playerName === 'å½“å‰ç”¨æˆ·';
                    
                    row.innerHTML = `
                        <td>
                            <span class="rank-number ${isTop3 ? 'top3' : ''} ${isTop3 ? `rank-${player.rank}` : ''}">
                                ${player.rank}
                            </span>
                        </td>
                        <td>
                            <span class="player-name ${isTop3 ? 'top3' : ''}">
                                ${player.playerName}${isCurrentUser ? ' (æˆ‘)' : ''}
                            </span>
                        </td>
                        <td>
                            <span class="time-display ${isTop3 ? 'top3' : ''}">
                                ${this.formatTime(player.totalTime)}
                            </span>
                        </td>
                        <td>
                            <span class="steps-display ${isTop3 ? 'top3' : ''}">
                                ${player.totalSteps}
                            </span>
                        </td>
                    `;
                    
                    this.rankTableBody.appendChild(row);
                });
            }

            formatTime(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }

            showLoading() {
                this.hideAllMessages();
                this.loadingMessage.style.display = 'block';
                // åˆ·æ–°æŒ‰é’®ä¸å†æ”¹å˜æ–‡æ¡ˆæˆ–åšåŠ¨ç”»ï¼Œä»…çŸ­æš‚ç¦ç”¨é¿å…é‡å¤ç‚¹å‡»
                this.refreshBtn.disabled = true;
            }

            showError() {
                this.hideAllMessages();
                this.errorMessage.style.display = 'block';
                this.refreshBtn.disabled = false;
            }

            showEmpty() {
                this.hideAllMessages();
                this.emptyMessage.style.display = 'block';
                this.refreshBtn.disabled = false;
            }

            hideAllMessages() {
                this.loadingMessage.style.display = 'none';
                this.errorMessage.style.display = 'none';
                this.emptyMessage.style.display = 'none';
                this.rankTableContainer.style.display = 'none';
                this.myRankCard.style.display = 'none';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            new RankPage();
        });
    </script>
</body>
</html>
