<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="email=no">
    <meta name="format-detection" content="address=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#20223A">
    <title>AI ç”Ÿæˆå›¾ç‰‡</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mobile.css') }}">
</head>
<body>
{% include '_navbar.html' %}
<div class="background-blur"></div>
<div class="container" style="max-width: 1100px; margin: 20px auto;">
  <style>
    .ai-layout{display:flex;gap:20px;align-items:flex-start;height:680px}
    .ai-left{flex:0 0 260px;height:680px;overflow:auto}
    .ai-right{flex:1 1 auto;display:flex;flex-direction:column;gap:16px;height:680px}
    .ai-result{flex: 2 1 0;min-height:0;display:flex;align-items:center;justify-content:center}
    .ai-result img{max-width:100%;max-height:100%;object-fit:contain;border-radius:8px}
    .ai-chat{flex: 1 1 0;min-height:0;display:flex;flex-direction:column;padding:0;overflow:hidden}
    .ai-chat-box{height:100%;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px}
    .ai-chat-input{display:flex;gap:10px;padding:12px;border-top:1px solid rgba(255,255,255,0.1)}
    .ai-tag-title{font-size:14px;margin:6px 0 8px;color:#F9E078;opacity:.9}
    .ai-tags{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .tag-btn{height:36px;display:inline-flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,.15);background:transparent;color:#F9E078;border-radius:6px;cursor:pointer;pointer-events:auto;position:relative;z-index:1}
    .tag-btn:hover{background:rgba(249,224,120,0.08)}
    .tag-btn.active{outline:2px solid #F9E078;background:rgba(249,224,120,0.15);box-shadow:0 0 8px rgba(249,224,120,0.3)}
    .size-tag{font-size:10px;font-family:'Press Start 2P', monospace}
    .number-text{font-family:'Press Start 2P', monospace}
    .symbol-text{font-family:'Press Start 2P', monospace}
    
    /* ç§»åŠ¨ç«¯æ ·å¼ - çºµå‘æ’åˆ— */
    .mobile-device .ai-layout {
      display: flex;
      flex-direction: column;
      gap: 16px;
      height: auto;
      min-height: 100vh;
    }
    
    .mobile-device .ai-left {
      flex: none;
      height: auto;
      order: 1; /* æ ‡ç­¾æ¡†åœ¨æœ€ä¸Šé¢ */
      max-height: 300px;
      overflow-y: auto;
    }
    
    .mobile-device .ai-right {
      flex: none;
      height: auto;
      order: 3; /* ç”ŸæˆåŒºåŸŸåœ¨æœ€å */
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .mobile-device .ai-chat {
      flex: none;
      height: auto;
      order: 2; /* å¯¹è¯æ¡†åœ¨ç”ŸæˆåŒºåŸŸå†…ä¸‹æ–¹ */
      min-height: 200px;
    }
    
    .mobile-device .ai-result {
      flex: none;
      height: 300px;
      min-height: 300px;
      order: 1; /* ç”Ÿæˆç»“æœåœ¨ç”ŸæˆåŒºåŸŸå†…æœ€ä¸Šé¢ */
    }
    
    .mobile-device .ai-chat {
      flex: none;
      height: auto;
      order: 3; /* å¯¹è¯æ¡†åœ¨ç”ŸæˆåŒºåŸŸå†…ä¸‹æ–¹ */
      min-height: 150px;
    }
    
    .mobile-device .ai-chat-box {
      height: 150px;
      min-height: 150px;
      max-height: 150px;
    }
    
    .mobile-device #useImageBtn {
      order: 2; /* æŒ‰é’®åœ¨ç”Ÿæˆç»“æœå’Œå¯¹è¯æ¡†ä¹‹é—´ */
      margin-top: 8px;
      margin-bottom: 8px;
    }
    
    .mobile-device .ai-tags {
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }
    
    .mobile-device .tag-btn {
      height: 32px;
      font-size: 12px;
    }
    
    .mobile-device .ai-tag-title {
      font-size: 12px;
      margin: 4px 0 6px;
    }
    
    .mobile-device .container {
      margin: 10px auto !important;
      padding: 0 10px;
    }
    
    .mobile-device #makePuzzleBtn {
      height: 40px;
      font-size: 14px;
    }
  </style>
  <div class="ai-layout">
    <!-- æ ‡ç­¾æ¡† -->
    <aside class="card ai-left">
      <h3 style="margin-bottom:12px;">å¸¸ç”¨æ ‡ç­¾</h3>
      <div id="promptTags">
        <div class="ai-tag-title">å°ºå¯¸</div>
        <div class="ai-tags" id="sizeTags">
          <button class="tag-btn size-tag active" data-size="1024x1024"><span class="number-text">1024</span><span class="symbol-text">Ã—</span><span class="number-text">1024</span></button>
          <button class="tag-btn size-tag" data-size="1280x720"><span class="number-text">1280</span><span class="symbol-text">Ã—</span><span class="number-text">720</span></button>
          <button class="tag-btn size-tag" data-size="1024x768"><span class="number-text">1024</span><span class="symbol-text">Ã—</span><span class="number-text">768</span></button>
          <button class="tag-btn size-tag" data-size="720x1280"><span class="number-text">720</span><span class="symbol-text">Ã—</span><span class="number-text">1280</span></button>
        </div>
        <div class="ai-tag-title">ç”»é£</div>
        <div class="ai-tags">
          <button class="tag-btn" data-val="åƒç´ é£">åƒç´ é£</button>
          <button class="tag-btn" data-val="èµ›åšæœ‹å…‹">èµ›åšæœ‹å…‹</button>
          <button class="tag-btn" data-val="è’¸æ±½æ³¢">è’¸æ±½æ³¢</button>
          <button class="tag-btn" data-val="æ°´å½©">æ°´å½©</button>
          <button class="tag-btn" data-val="æ²¹ç”»">æ²¹ç”»</button>
          <button class="tag-btn" data-val="ä½å¤šè¾¹å½¢">ä½å¤šè¾¹å½¢</button>
          <button class="tag-btn" data-val="æ¼«ç”»">æ¼«ç”»</button>
          <button class="tag-btn" data-val="æ—¥ç³»">æ—¥ç³»</button>
          <button class="tag-btn" data-val="å†™å®">å†™å®</button>
          <button class="tag-btn" data-val="3Dæ¸²æŸ“"><span class="number-text">3</span><span class="symbol-text">D</span></span>æ¸²æŸ“</button>
        </div>
        <div class="ai-tag-title">å›¾ç‰‡ç±»å‹</div>
        <div class="ai-tags">
          <button class="tag-btn" data-val="è‡ªç„¶é£æ™¯">è‡ªç„¶é£æ™¯</button>
          <button class="tag-btn" data-val="åŸå¸‚å¤œæ™¯">åŸå¸‚å¤œæ™¯</button>
          <button class="tag-btn" data-val="äººç‰©è‚–åƒ">äººç‰©è‚–åƒ</button>
          <button class="tag-btn" data-val="åŠ¨ç‰©">åŠ¨ç‰©</button>
          <button class="tag-btn" data-val="å»ºç­‘">å»ºç­‘</button>
          <button class="tag-btn" data-val="é£Ÿç‰©">é£Ÿç‰©</button>
          <button class="tag-btn" data-val="ç§‘å¹»æœºç”²">ç§‘å¹»æœºç”²</button>
          <button class="tag-btn" data-val="å¥‡å¹»">å¥‡å¹»</button>
        </div>
        <div class="ai-tag-title">å…¶ä»–</div>
        <div class="ai-tags">
          <button class="tag-btn" data-val="é»„æ˜å…‰å½±">é»„æ˜å…‰å½±</button>
          <button class="tag-btn" data-val="ä½“ç§¯å…‰">ä½“ç§¯å…‰</button>
          <button class="tag-btn" data-val="é«˜å¯¹æ¯”">é«˜å¯¹æ¯”</button>
          <button class="tag-btn" data-val="æŸ”å’Œè‰²è°ƒ">æŸ”å’Œè‰²è°ƒ</button>
          <button class="tag-btn" data-val="å†·è‰²è°ƒ">å†·è‰²è°ƒ</button>
          <button class="tag-btn" data-val="æš–è‰²è°ƒ">æš–è‰²è°ƒ</button>
        </div>
      </div>
    </aside>

    <!-- ç”ŸæˆåŒºåŸŸ -->
    <section class="ai-right">
      <!-- ç”Ÿæˆç»“æœå±•ç¤º -->
      <div id="aiResult" class="card ai-result">
        <img id="aiImg" src="" alt="AIå›¾ç‰‡" style="display:none;">
        <div id="aiPlaceholder" style="color:#F9E078; opacity:.7;">ç”Ÿæˆç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
      </div>
      
      <!-- ä½¿ç”¨å›¾ç‰‡æŒ‰é’® -->
      <div id="useImageBtn" class="card" style="display:none; padding:12px;">
        <button id="makePuzzleBtn" class="btn btn-primary" style="width:100%;">ä½¿ç”¨è¿™ä¸ªå›¾ç‰‡åˆ¶ä½œæ‹¼å›¾</button>
      </div>
      
      <!-- å¯¹è¯æ¡† -->
      <div class="card ai-chat">
        <div id="chatBox" class="ai-chat-box"></div>
        <div class="ai-chat-input">
          <input id="aiPrompt" placeholder="è¾“å…¥æè¿°ï¼Œä¾‹å¦‚ï¼šåƒç´ é£æ£®æ—ä¸­çš„å°å±‹ï¼Œé»„æ˜å…‰å½±" style="flex:1; padding:10px 12px; border:1px solid #E5E7EB; border-radius:6px;">
          <button id="genBtn" class="btn btn-primary">ç”Ÿæˆ</button>
        </div>
        <div style="padding: 0 12px 12px 12px;"><span id="aiTip" style="font-size:12px;color:#F9E078;opacity:.8;"></span></div>
      </div>
    </section>
  </div>
</div>

<script>
// ç§»åŠ¨ç«¯è®¾å¤‡æ£€æµ‹
(function() {
    'use strict';
    
    function isMobile() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
               window.innerWidth <= 768;
    }
    
    function addMobileClass() {
        if (isMobile()) {
            document.body.classList.add('mobile-device');
        }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', addMobileClass);
    } else {
        addMobileClass();
    }
    
    // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°æ£€æµ‹
    window.addEventListener('resize', function() {
        setTimeout(addMobileClass, 100);
    });
})();
</script>

<script>
const genBtn=document.getElementById('genBtn');
const aiPrompt=document.getElementById('aiPrompt');
const aiTip=document.getElementById('aiTip');
const aiResult=document.getElementById('aiResult');
const aiImg=document.getElementById('aiImg');
const aiPlaceholder=document.getElementById('aiPlaceholder');
const chatBox=document.getElementById('chatBox');
const promptTags=document.getElementById('promptTags');
const sizeTags=document.getElementById('sizeTags');
const useImageBtn=document.getElementById('useImageBtn');
const makePuzzleBtn=document.getElementById('makePuzzleBtn');
let selectedSize="1024x1024"; // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªå°ºå¯¸
let currentImageUrl = ""; // å­˜å‚¨å½“å‰ç”Ÿæˆçš„å›¾ç‰‡URL

function appendMsg(who,text){
  const row=document.createElement('div');
  row.style.display='flex';
  row.style.gap='8px';
  row.style.alignItems='flex-start';
  const badge=document.createElement('span');
  badge.textContent=who;
  badge.style.background='rgba(249,224,120,0.12)';
  badge.style.border='1px solid rgba(249,224,120,0.35)';
  badge.style.color='#F9E078';
  badge.style.borderRadius='6px';
  badge.style.fontSize='12px';
  badge.style.padding='2px 6px';
  const textEl=document.createElement('div');
  textEl.textContent=text;
  row.appendChild(badge);
  row.appendChild(textEl);
  chatBox.appendChild(row);
  chatBox.scrollTop=chatBox.scrollHeight;
}

promptTags.addEventListener('click',(e)=>{
  if(e.target && e.target.matches('button[data-val]')){
    const val=e.target.getAttribute('data-val');
    if(aiPrompt.value){ aiPrompt.value += 'ï¼Œ' + val; } else { aiPrompt.value = val; }
    aiPrompt.focus();
  }
});

sizeTags.addEventListener('click',(e)=>{
  if(e.target && e.target.matches('button[data-size]')){
    // toggle active
    [...sizeTags.querySelectorAll('button')].forEach(b=>b.classList.remove('active'));
    e.target.classList.add('active');
    selectedSize=e.target.getAttribute('data-size');
    console.log('å°ºå¯¸é€‰æ‹©:', selectedSize); // è°ƒè¯•ä¿¡æ¯
  }
});

genBtn.addEventListener('click', async ()=>{
  const token=localStorage.getItem('puzzleToken');
  if(!token){
    aiTip.textContent='è¯·å…ˆç™»å½•åå†ä½¿ç”¨ AI ç”ŸæˆåŠŸèƒ½ã€‚';
    return;
  }
  const prompt=(aiPrompt.value||'').trim();
  if(!prompt){ aiTip.textContent='è¯·è¾“å…¥æè¿°'; return; }
  console.log('å½“å‰é€‰æ‹©çš„å°ºå¯¸:', selectedSize); // è°ƒè¯•ä¿¡æ¯
  aiTip.textContent='ç”Ÿæˆä¸­...';
  appendMsg('æˆ‘', prompt);
  try{
    const form=new FormData();
    form.append('prompt', prompt);
    const res=await fetch('/ai/generate',{ method:'POST', body:form });
    const json=await res.json();
    if(json.code===200 && json.data && json.data.url){
      let url=json.data.url;
      if(selectedSize){
        const [w,h]=selectedSize.split('x');
        url += `?width=${encodeURIComponent(w)}&height=${encodeURIComponent(h)}`;
      }
      // ä¿å­˜å›¾ç‰‡URLç”¨äºåˆ¶ä½œæ‹¼å›¾
      currentImageUrl = url;
      aiImg.src=url;
      aiResult.style.display='flex';
      aiImg.style.display='block';
      if(aiPlaceholder) aiPlaceholder.style.display='none';
      // æ˜¾ç¤ºä½¿ç”¨å›¾ç‰‡æŒ‰é’®
      useImageBtn.style.display='block';
      appendMsg('AI', 'å·²ç”Ÿæˆå›¾ç‰‡ï¼Œè§ä¸Šæ–¹é¢„è§ˆ');
      aiTip.textContent='';
    }else{
      aiTip.textContent=json.message||'ç”Ÿæˆå¤±è´¥';
      appendMsg('AI', 'ç”Ÿæˆå¤±è´¥');
    }
  }catch(e){ aiTip.textContent='ç½‘ç»œé”™è¯¯'; }
});

// ä½¿ç”¨å›¾ç‰‡åˆ¶ä½œæ‹¼å›¾æŒ‰é’®ç‚¹å‡»äº‹ä»¶
makePuzzleBtn.addEventListener('click', ()=>{
  if(!currentImageUrl){
    aiTip.textContent='è¯·å…ˆç”Ÿæˆå›¾ç‰‡';
    return;
  }
  
  // å°†å›¾ç‰‡URLä¿å­˜åˆ°localStorageï¼Œä¾›ç¼–è¾‘å™¨é¡µé¢ä½¿ç”¨
  // ä½¿ç”¨ç¼–è¾‘å™¨é¡µé¢æœŸæœ›çš„é”®åå’Œé»˜è®¤è®¾ç½®
  localStorage.setItem('customImage', currentImageUrl);
  localStorage.setItem('customSize', '16'); // é»˜è®¤16å—æ‹¼å›¾
  localStorage.setItem('customShape', 'rect'); // é»˜è®¤çŸ©å½¢
  localStorage.setItem('randomRotation', 'false'); // é»˜è®¤ä¸éšæœºæ—‹è½¬
  localStorage.setItem('randomFlip', 'false'); // é»˜è®¤ä¸éšæœºç¿»è½¬
  
  // è·³è½¬åˆ°ç¼–è¾‘å™¨é¡µé¢
  window.location.href = '/editor';
});
</script>

<!-- å¸®åŠ©é¡µé¢æ¨¡æ€æ¡† -->
<div class="modal-mask" id="helpModal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <span>æ“ä½œæŒ‡å—</span>
            <span class="modal-close" onclick="document.getElementById('helpModal').style.display='none'">Ã—</span>
        </div>
        <div class="modal-body" style="font-size: 14px; line-height: 24px; color: #E0E0E0;">
            <!-- æ¡Œé¢ç«¯æ“ä½œæŒ‡å— -->
            <div id="desktop-help" style="display: none;">
                <p><strong style="color: #F9E078;">1. AIç”Ÿæˆæ‹¼å›¾</strong></p>
                <p>- è¾“å…¥æè¿°æ–‡å­—ï¼ŒAIå°†ç”Ÿæˆç›¸åº”çš„æ‹¼å›¾å›¾ç‰‡</p>
                <p>- æ”¯æŒä¸­æ–‡å’Œè‹±æ–‡æè¿°ï¼Œæè¿°è¶Šè¯¦ç»†æ•ˆæœè¶Šå¥½</p>
                <p>- ç”Ÿæˆåå¯è®¾ç½®æ‹¼å›¾å—æ•°ã€å½¢çŠ¶ç­‰å‚æ•°</p>
                <p><strong style="color: #F9E078; margin-top: 16px; display: block;">2. è‡ªå®šä¹‰æ‹¼å›¾</strong></p>
                <p>- æ”¯æŒä¸Šä¼ æœ¬åœ°å›¾ç‰‡ï¼ˆJPG/PNGï¼Œæœ€å¤§5MBï¼‰ï¼Œå¯è£å‰ªè°ƒæ•´</p>
                <p>- å¯è®¾ç½®æ‹¼å›¾å—æ•°ï¼ˆ4-64å—ï¼‰ã€å½¢çŠ¶ï¼ˆçŸ©å½¢/å¼‚å½¢ï¼‰ã€æ˜¯å¦æ—‹è½¬</p>
                <p><strong style="color: #F9E078; margin-top: 16px; display: block;">3. å­˜æ¡£ä¸åˆ†äº«</strong></p>
                <p>- ç™»å½•ç”¨æˆ·å­˜æ¡£åŒæ­¥è‡³æœåŠ¡å™¨ï¼Œæ¸¸å®¢å­˜æ¡£ä»…ä¿å­˜åœ¨å½“å‰æµè§ˆå™¨</p>
                <p>- è‡ªå®šä¹‰æ‹¼å›¾å¯åˆ†äº«è‡³"åˆ†äº«ä¸­å¿ƒ"ï¼Œä¾›å…¶ä»–ç©å®¶æ¸¸ç©</p>
            </div>
            
            <!-- ç§»åŠ¨ç«¯æ“ä½œæŒ‡å— -->
            <div id="mobile-help" style="display: none;">
                <p><strong style="color: #F9E078;">ğŸ“± AIç”Ÿæˆæ‹¼å›¾æŒ‡å—</strong></p>
                <p><strong style="color: #F9E078;">1. AIç”Ÿæˆæ‹¼å›¾</strong></p>
                <p>- è¾“å…¥æè¿°æ–‡å­—ï¼ŒAIå°†ç”Ÿæˆç›¸åº”çš„æ‹¼å›¾å›¾ç‰‡</p>
                <p>- æ”¯æŒä¸­æ–‡å’Œè‹±æ–‡æè¿°ï¼Œæè¿°è¶Šè¯¦ç»†æ•ˆæœè¶Šå¥½</p>
                <p>- ç”Ÿæˆåå¯è®¾ç½®æ‹¼å›¾å—æ•°ã€å½¢çŠ¶ç­‰å‚æ•°</p>
                <p><strong style="color: #F9E078; margin-top: 16px; display: block;">2. æ‹¼å›¾æ“ä½œ</strong></p>
                <p>- é•¿æŒ‰æ‹¼å›¾å—å¼€å§‹æ‹–æ‹½åˆ°æ£‹ç›˜</p>
                <p>- åŒå‡»æ—‹è½¬æ‹¼å›¾å—ï¼Œä¸‰å‡»ç¿»è½¬æ‹¼å›¾å—</p>
                <p>- å•å‡»é€‰ä¸­æ‹¼å›¾å—æ˜¾ç¤ºé€‰ä¸­æ•ˆæœ</p>
                <p><strong style="color: #F9E078; margin-top: 16px; display: block;">3. æ¸¸æˆæ§åˆ¶</strong></p>
                <p>- ç‚¹å‡»"æ’¤é”€"å¯è¿˜åŸä¸Šä¸€æ­¥æ“ä½œ</p>
                <p>- ç‚¹å‡»"ä¿å­˜è¿›åº¦"ä¿å­˜å½“å‰æ¸¸æˆçŠ¶æ€</p>
                <p>- ç‚¹å‡»"æ¢å¤è¿›åº¦"æ¢å¤ä¹‹å‰ä¿å­˜çš„æ¸¸æˆ</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="document.getElementById('helpModal').style.display='none'">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>
</div>
    <!-- é¡µé¢ç‰¹å®šçš„èƒŒæ™¯éŸ³ä¹ -->
    <script>
        // ç­‰å¾…éŸ³ä¹ç®¡ç†å™¨åŠ è½½å®Œæˆ
        function initPageMusic() {
            if (window.musicManager) {
                // AIç”Ÿæˆé¡µé¢è‡ªåŠ¨æ’­æ”¾AIéŸ³ä¹
                window.musicManager.playScene('ai');
            } else {
                // å¦‚æœéŸ³ä¹ç®¡ç†å™¨å°šæœªåŠ è½½ï¼Œç¨åé‡è¯•
                setTimeout(initPageMusic, 100);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåç›´æ¥åˆå§‹åŒ–éŸ³ä¹ï¼Œæ— éœ€ç­‰å¾…ç”¨æˆ·äº¤äº’
        document.addEventListener('DOMContentLoaded', function() {
            // ç›´æ¥å°è¯•æ’­æ”¾éŸ³ä¹
            initPageMusic();
        });
    </script>
    </body>
</html>


