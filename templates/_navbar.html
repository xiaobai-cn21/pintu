<nav class="pm-navbar">
    <a class="pm-brand" href="{{ url_for('main') }}">PuzzleMaster</a>
    <div class="pm-nav-links-row">
        <a class="pm-link chinese-text" href="{{ url_for('main') }}">é¦–é¡µ</a>
        <a class="pm-link chinese-text" href="{{ url_for('option_page') }}">å¼€å§‹æ¸¸æˆ</a>
        <a class="pm-link chinese-text" id="pm-help-link" href="#">å¸®åŠ©</a>
    </div>
    <div class="pm-nav-right">
        <!-- éŸ³ä¹æ§åˆ¶æŒ‰é’® -->
        <button id="musicToggle" class="pm-music-btn" title="åˆ‡æ¢èƒŒæ™¯éŸ³ä¹">
            <span id="musicIcon" aria-hidden="true">ğŸµ</span>
        </button>
        <button id="inviteToggle" class="pm-invite-btn" title="æŒ‘æˆ˜é‚€è¯·" aria-label="æŒ‘æˆ˜é‚€è¯·">
            <span aria-hidden="true">ğŸ””</span>
            <span id="inviteBadge" class="pm-badge-dot" style="display:none;"></span>
        </button>
        <span id="pm-username-label" class="pm-username">æœªç™»å½•</span>
        
        <div class="pm-avatar-wrap" id="pm-avatar-wrap">
            <img class="pm-avatar" src="{{ url_for('static', filename='images/ç”¨æˆ·å¤´åƒ.jpg') }}" alt="avatar">
            <div class="pm-avatar-menu" id="pm-avatar-menu">
                <button id="pm-login-btn" class="pm-menu-item chinese-text"><span class="chinese-text">ç™»å½•</span><span class="symbol-text"> / </span><span class="chinese-text">æ³¨å†Œ</span></button>
                <a id="pm-my-puzzle-btn" class="pm-menu-item chinese-text" href="{{ url_for('my_puzzle_page') }}" style="display:none;"><span class="chinese-text">æˆ‘çš„æ‹¼å›¾</span></a>
                <a id="pm-friend-btn" class="pm-menu-item chinese-text" href="{{ url_for('friends_page') }}" style="display:none;"><span class="chinese-text">æ·»åŠ å¥½å‹</span></a>
                <a id="pm-messages-btn" class="pm-menu-item chinese-text" href="{{ url_for('messages_page') }}" style="display:none;"><span class="chinese-text">æ¶ˆæ¯ä¸­å¿ƒ</span></a>
                <button id="pm-logout-btn" class="pm-menu-item chinese-text" style="display:none;"><span class="chinese-text">é€€å‡ºç™»å½•</span></button>
            </div>
        </div>
    </div>
</nav>

<style>
/* éŸ³ä¹æ§åˆ¶æŒ‰é’®æ ·å¼ */
.pm-music-btn {
    background: transparent;
    border: none;
    color: #F9E078;
    font-size: 18px;
    padding: 8px 12px;
    cursor: pointer;
    margin-right: 3px;
    transition: transform 0.2s ease;
}

.pm-music-btn:hover {
    transform: scale(1.1);
}

.pm-username {
    color: #F9E078;
    font-size: 12px;
    margin-right: 8px;
    font-family: 'Press Start 2P', 'Zpix', monospace;
}
.pm-username.guest {
    font-size: 14px;
}

/* æŒ‘æˆ˜é‚€è¯·æŒ‰é’®æ ·å¼ */
.pm-invite-btn {
    background: transparent;
    border: none;
    color: #F9E078;
    font-size: 18px;
    padding: 8px 12px;
    cursor: pointer;
    margin-right: 8px;
    position: relative;
}
.pm-badge-dot {
    position: absolute;
    top: 6px;
    right: 6px;
    width: 8px;
    height: 8px;
    background: #FF4D4F;
    border-radius: 50%;
    box-shadow: 0 0 6px rgba(255,77,79,0.8);
}
</style>
<script>
// Font Awesome å·²æ›¿æ¢ä¸ºæœ¬åœ° Emojiï¼Œæ— éœ€åŠ¨æ€åŠ è½½å¤–éƒ¨ CDN
// åŠ è½½éŸ³ä¹ç®¡ç†æ¨¡å—
const musicScript = document.createElement('script');
musicScript.src = '/static/js/music.js';
musicScript.onload = function() {
    initMusicControl();
};
document.body.appendChild(musicScript);

// åŠ è½½ç®€å•ç›´æ¥çš„ç‚¹å‡»éŸ³æ•ˆæ¨¡å—ï¼ˆç‹¬ç«‹äºéŸ³ä¹ç®¡ç†å™¨ï¼‰
const clickSoundScript = document.createElement('script');
clickSoundScript.src = '/static/js/click_sound.js';
clickSoundScript.onload = function() {
    console.log('ç‚¹å‡»éŸ³æ•ˆæ¨¡å—åŠ è½½å®Œæˆ');
};
document.body.appendChild(clickSoundScript);

(function(){
  const token = localStorage.getItem('puzzleToken');
  const loginBtn = document.getElementById('pm-login-btn');
  const logoutBtn = document.getElementById('pm-logout-btn');
  const myPuzzleBtn = document.getElementById('pm-my-puzzle-btn');
  const friendBtn = document.getElementById('pm-friend-btn');
  const messagesBtn = document.getElementById('pm-messages-btn');
  const usernameLabel = document.getElementById('pm-username-label');
  const inviteBtn = document.getElementById('inviteToggle');
  const inviteBadge = document.getElementById('inviteBadge');
  if(token){
    loginBtn.style.display='none';
    logoutBtn.style.display='block';
    myPuzzleBtn.style.display='block';
    friendBtn && (friendBtn.style.display='block');
    messagesBtn && (messagesBtn.style.display='block');
    usernameLabel && usernameLabel.classList.remove('guest');
    (async function(){
      try{
        const res = await fetch('/auth/me', { headers: { 'Authorization': 'Bearer ' + token } });
        const json = await res.json();
        const uname = (json && json.data && json.data.username) || localStorage.getItem('username') || localStorage.getItem('nickName') || 'å·²ç™»å½•';
        if (usernameLabel) { usernameLabel.textContent = uname; }
        localStorage.setItem('username', uname);
      }catch(e){ if (usernameLabel) { usernameLabel.textContent = localStorage.getItem('username') || 'å·²ç™»å½•'; } }
    })();
  } else {
    loginBtn.style.display='block';
    logoutBtn.style.display='none';
    myPuzzleBtn.style.display='none';
    friendBtn && (friendBtn.style.display='none');
    messagesBtn && (messagesBtn.style.display='none');
    if (usernameLabel) {
      usernameLabel.textContent = 'æœªç™»å½•';
      usernameLabel.classList.add('guest');
    }
  }
  loginBtn && (loginBtn.onclick = function(){
    const modal = document.getElementById('loginModal');
    if(modal){ modal.style.display='flex'; } else { window.location.href='{{ url_for('main') }}'; }
  });
  logoutBtn && (logoutBtn.onclick = function(){
    localStorage.removeItem('puzzleToken');
    localStorage.removeItem('userId');
    window.location.reload();
  });
  const helpLink = document.getElementById('pm-help-link');
  if(helpLink){
    helpLink.addEventListener('click', function(e){
      e.preventDefault();
      e.stopPropagation();
      const help = document.getElementById('helpModal');
      if(help){ 
        help.style.display='flex'; 
        
        // æ ¹æ®è®¾å¤‡ç±»å‹æ˜¾ç¤ºç›¸åº”çš„å¸®åŠ©å†…å®¹
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
        const desktopHelp = document.getElementById('desktop-help');
        const mobileHelp = document.getElementById('mobile-help');
        
        if (desktopHelp && mobileHelp) {
          if (isMobile) {
            desktopHelp.style.display = 'none';
            mobileHelp.style.display = 'block';
          } else {
            desktopHelp.style.display = 'block';
            mobileHelp.style.display = 'none';
          }
        }
      }
    });
  }


  // æ§åˆ¶å¤´åƒèœå•æ‰“å¼€/å…³é—­ï¼Œä¸ä¾èµ– hoverï¼Œé¿å…é—ªé€€
  const wrap = document.getElementById('pm-avatar-wrap');
  const menu = document.getElementById('pm-avatar-menu');
  const avatar = document.querySelector('.pm-avatar');
  function openMenu(){ wrap.classList.add('open'); }
  function closeMenu(){ wrap.classList.remove('open'); }
  avatar && avatar.addEventListener('click', (e)=>{
    e.stopPropagation();
    if(wrap.classList.contains('open')) closeMenu(); else openMenu();
  });
  menu && menu.addEventListener('click',(e)=>{ e.stopPropagation(); });
  document.addEventListener('click', ()=> closeMenu());
})();

// æš´éœ²å…¨å±€æ§åˆ¶æŒ‘æˆ˜é‚€è¯·çº¢ç‚¹çš„API
window.challengeInvite = {
  set(has) {
    const badge = document.getElementById('inviteBadge');
    if (!badge) return;
    badge.style.display = has ? 'block' : 'none';
  }
};

// ç‚¹å‡»é‚€è¯·æŒ‰é’®ï¼Œè·³è½¬åˆ°å¯¹æˆ˜é¡µï¼ˆå¯æ”¹ä¸ºå¼¹å‡ºé‚€è¯·åˆ—è¡¨ï¼‰
document.getElementById('inviteToggle')?.addEventListener('click', function(){
  window.location.href = '{{ url_for('versus_page') }}';
});

// åˆå§‹åŒ–éŸ³ä¹æ§åˆ¶
function initMusicControl() {
  // ç­‰å¾…DOMåŠ è½½å®Œæˆ
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupMusicButton);
  } else {
    setupMusicButton();
  }
  
  function setupMusicButton() {
    const musicToggle = document.getElementById('musicToggle');
    const musicIcon = document.getElementById('musicIcon');
    if (musicToggle && window.musicManager) {
      // æ›´æ–°å›¾æ ‡æ˜¾ç¤º
      function updateMusicIcon() {
        if (musicIcon) {
          musicIcon.textContent = window.musicManager.isMuted ? 'ğŸ”‡' : 'ğŸµ';
        }
      }
      
      // è®¾ç½®åˆå§‹çŠ¶æ€
      updateMusicIcon();
      
      // æ·»åŠ ç‚¹å‡»äº‹ä»¶
      musicToggle.addEventListener('click', function() {
        const isMuted = window.musicManager.toggleMute();
        updateMusicIcon();
      });
    }
  }
}
</script>

