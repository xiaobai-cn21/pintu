<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…³å¡æ’è¡Œæ¦œ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/game-rank.css') }}">
    <style>
        .rank-container { max-width: 1000px; margin: 80px auto 20px; padding: 20px; background: #20223A; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,.3); }
        .rank-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #F9E078; }
        .back-btn { background-color: #F9E078; color: #20223A; border: none; padding: 8px 16px; border-radius: 0; cursor: pointer; text-decoration: none; display: inline-block; font-family: 'Press Start 2P', 'Zpix', monospace; font-size: 12px; }
        .back-btn:hover { background-color: #E6D166; }
        .rank-title { font-weight: bold; color: #F9E078; margin: 0; font-family: 'Press Start 2P', 'Zpix', monospace; font-size: 18px; }
        .refresh-btn { background: #F9E078; color: #20223A; border: none; cursor: pointer; font-size: 12px; padding: 8px 16px; border-radius: 0; font-family: 'Press Start 2P', 'Zpix', monospace; }
        .level-info { background: linear-gradient(135deg,#36D1DC 0%,#5B86E5 100%); color:#fff; padding:20px; border-radius:10px; margin-bottom:20px; box-shadow:0 4px 15px rgba(54,209,220,.3); text-align: center; }
        .level-name { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
        .level-details { font-size: 16px; opacity: 0.9; }
        .my-rank-card { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; padding:20px; border-radius:10px; margin-bottom:20px; box-shadow:0 4px 15px rgba(102,126,234,.3); }
        .my-rank-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; }
        .my-rank-title::before { content: "ğŸ‘¤"; margin-right: 8px; }
        .my-rank-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .my-rank-item { text-align: center; }
        .my-rank-label { font-size: 12px; opacity: .8; margin-bottom: 5px; }
        .my-rank-value { font-size: 20px; font-weight: bold; }
        .rank-table { width: 100%; border-collapse: collapse; background: #20223A; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,.25); }
        .rank-table th { background: #2a2c4a; color:#F9E078; padding: 15px; text-align: center; font-weight: bold; font-size: 18px; }
        .rank-table td { padding: 16px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.08); font-size: 16px; color:#F9E078; }
        .rank-table tr:hover { background-color: rgba(255,255,255,0.04); }
        .rank-number { font-weight: bold; font-size: 20px; }
        .rank-number.top3 { font-size: 22px; }
        .rank-number.rank-1 { color: #ffd700; }
        .rank-number.rank-2 { color: #c0c0c0; }
        .rank-number.rank-3 { color: #cd7f32; }
        .player-name { font-weight: 500; }
        .player-name.top3 { font-weight: bold; }
        .time-display { font-family: 'Courier New', monospace; font-weight: 500; }
        .time-display.top3 { font-weight: bold; }
        .steps-display { font-weight: 500; }
        .steps-display.top3 { font-weight: bold; }
        .loading-message,.error-message,.empty-message { text-align:center; padding:40px; font-size:18px; }
        .error-message { color:#e74c3c; }
        @media (max-width: 768px) {
            .rank-container { margin:10px; padding:15px; }
            .rank-header { flex-direction: column; gap: 15px; text-align: center; }
            .rank-title { font-size: 28px; }
            .rank-table th { font-size: 16px; }
            .rank-table td { font-size: 15px; padding: 12px 6px; }
        }
        @media (max-width: 480px) {
            .rank-table th { font-size: 14px; }
            .rank-table td { font-size: 14px; padding: 10px 4px; }
            .my-rank-info { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    {% include '_navbar.html' %}
    <div class="background-blur"></div>
    <div class="rank-container">
        <div class="rank-header">
            <button class="btn btn-secondary back-btn" onclick="window.location.href='{{ url_for('main') }}'" style="padding: 8px 16px; font-size: 12px;">
                <span class="chinese-text">è¿”å›ä¸»ç•Œé¢</span>
            </button>
            <h1 class="rank-title chinese-text">å…³å¡æ’è¡Œæ¦œ</h1>
            <button id="refreshBtn" class="btn refresh-btn" title="åˆ·æ–°æ•°æ®" style="padding: 8px 16px; font-size: 12px;">
                <span class="chinese-text">åˆ·æ–°</span>
            </button>
        </div>
        
        <!-- å…³å¡ä¿¡æ¯å¡ç‰‡ -->
        <div class="level-info">
            <div class="level-name" id="currentLevelName">æµ·æ´‹ä¸–ç•Œ</div>
            <div class="level-details" id="currentLevelDetails">éš¾åº¦: ä¸­ç­‰ | æ‹¼å›¾å—æ•°: 36 | æœ€ä½³è®°å½•: 00:03:45</div>
        </div>
        
        <!-- æˆ‘çš„æ’åå¡ç‰‡ -->
        <div id="myRankCard" class="my-rank-card" style="display:block;">
            <div class="my-rank-title">æˆ‘çš„æˆç»©</div>
            <div class="my-rank-info">
                <div class="my-rank-item"><div class="my-rank-label">æ’å</div><div class="my-rank-value" id="myRank">5</div></div>
                <div class="my-rank-item"><div class="my-rank-label">ç”¨æ—¶</div><div class="my-rank-value" id="myTotalTime">00:05:30</div></div>
                <div class="my-rank-item"><div class="my-rank-label">æ­¥æ•°</div><div class="my-rank-value" id="myTotalSteps">128</div></div>
            </div>
        </div>
        
        <!-- æ’è¡Œæ¦œè¡¨æ ¼ -->
        <div id="rankTableContainer" style="display:block;">
            <table class="rank-table">
                <thead><tr><th>æ’å</th><th>ç©å®¶</th><th>æ¸¸æˆç”¨æ—¶</th><th>æ­¥æ•°</th></tr></thead>
                <tbody id="rankTableBody"></tbody>
            </table>
        </div>
        
        <!-- çŠ¶æ€æç¤º -->
        <div id="loadingMessage" class="loading-message" style="display:none;">æ­£åœ¨åŠ è½½æ’è¡Œæ¦œæ•°æ®...</div>
        <div id="errorMessage" class="error-message" style="display:none;">âŒ åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>
        <div id="emptyMessage" class="empty-message" style="display:none;">æš‚æ— æ’è¡Œæ¦œæ•°æ®</div>
    </div>
    
    <script>
        class LevelRankPage {
            constructor() {
                // è·å–DOMå…ƒç´ 
                this.refreshBtn = document.getElementById('refreshBtn');
                this.currentLevelName = document.getElementById('currentLevelName');
                this.currentLevelDetails = document.getElementById('currentLevelDetails');
                this.myRankCard = document.getElementById('myRankCard');
                this.rankTableBody = document.getElementById('rankTableBody');
                this.loadingMessage = document.getElementById('loadingMessage');
                this.errorMessage = document.getElementById('errorMessage');
                this.emptyMessage = document.getElementById('emptyMessage');
                this.rankTableContainer = document.getElementById('rankTableContainer');
                
                // ä»URLè·å–å…³å¡IDï¼Œé»˜è®¤ä¸º1
                const urlParams = new URLSearchParams(window.location.search);
                // ä¼˜å…ˆä»URLè·å–ï¼ŒURLæ²¡æœ‰åˆ™ä»localStorageè·å–ï¼Œéƒ½æ²¡æœ‰åˆ™ç”¨é»˜è®¤1
                this.levelId = urlParams.get('levelId') || localStorage.getItem('selectedLevelForRanking') || '1';
                // å¯é€‰ï¼šè·å–åæ¸…é™¤localStorageä¸­çš„å¤‡ä»½ï¼ˆé¿å…ä¸‹æ¬¡è¯¯ç”¨æ—§å€¼ï¼‰
                localStorage.removeItem('selectedLevelForRanking');
                
                // ç»‘å®šäº‹ä»¶
                this.bindEvents();
                
                // åˆå§‹åŒ–é¡µé¢ï¼ˆå¼‚æ­¥ï¼‰
                this.initPage();
            }
            
            // å¼‚æ­¥åˆå§‹åŒ–é¡µé¢
async initPage() {
    this.showLoading(); // å…ˆæ˜¾ç¤ºåŠ è½½ä¸­
    try {
        // 1. è·å–å…³å¡ä¿¡æ¯ï¼ˆè‹¥å¤±è´¥ä¼šæŠ›å‡ºé”™è¯¯ï¼Œè¿›å…¥catchï¼‰
        this.levelData = await this.getLevelData(this.levelId);
        
        // 2. åªæœ‰è·å–åˆ°æœ‰æ•ˆæ•°æ®ï¼Œæ‰æ›´æ–°å…³å¡ä¿¡æ¯
        this.updateLevelInfo();
        
        // 3. åŠ è½½æ’åæ•°æ®ï¼ˆè‹¥æ’åæ¥å£å¤±è´¥ï¼Œä¸å½±å“å…³å¡ä¿¡æ¯æ˜¾ç¤ºï¼‰
        await this.loadRankData();
        
        // 4. æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆï¼Œæ˜¾ç¤ºæ­£å¸¸å†…å®¹
        this.hideAll();
        this.rankTableContainer.style.display = 'block';
        this.myRankCard.style.display = 'block';
    } catch (e) {
        console.error('åˆå§‹åŒ–é¡µé¢å¤±è´¥:', e);
        // å¼‚å¸¸æ—¶ï¼Œä¿æŒé”™è¯¯æç¤ºçŠ¶æ€ï¼ˆä¸æ˜¾ç¤ºé»˜è®¤å…³å¡å†…å®¹ï¼‰
        this.showError(); // è‹¥ getLevelData å·²è°ƒç”¨ showErrorï¼Œè¿™é‡Œå¯çœç•¥
    }
}
            
            // è·å–å…³å¡ä¿¡æ¯ï¼ˆå¼‚æ­¥ï¼‰
            async getLevelData(levelId) {
                try {
                    const response = await fetch(`/ranking/level-info/${parseInt(levelId)}`);
                    const result = await response.json();
                    
                    // 1. å¤„ç†éæˆåŠŸçŠ¶æ€ï¼ˆå¦‚æœåŠ¡å™¨é”™è¯¯ï¼‰
                    if (result.code !== 200 || !result.data) {
                        this.showError(`è·å–å…³å¡ä¿¡æ¯å¤±è´¥ï¼š${result.msg || 'æœªçŸ¥é”™è¯¯'}`);
                        throw new Error(`APIè¿”å›å¼‚å¸¸ï¼š${result.code}`);
                    }
                    
                    // 2. æ­£å¸¸è·å–æ•°æ®ï¼Œè½¬æ¢æ ¼å¼ï¼ˆå«æœ€ä½³è®°å½•æ‰©å±•ï¼‰
                    const difficultyMap = {
                        'easy': 'ç®€å•',
                        'medium': 'ä¸­ç­‰',
                        'hard': 'å›°éš¾',
                        'custom': 'è‡ªå®šä¹‰'
                    };
                    
                    return {
                        name: result.data.level_name, // å…³å¡åï¼ˆåç«¯è¿”å›çš„çœŸå®åç§°æˆ–é»˜è®¤åç§°ï¼‰
                        difficulty: difficultyMap[result.data.difficulty] || result.data.difficulty, // ä¸­æ–‡éš¾åº¦
                        pieceCount: result.data.piece_count, // çœŸå®å—æ•°æˆ–é»˜è®¤å—æ•°
                        bestRecord: 'æš‚æ— è®°å½•' // å½“å‰æ— çœŸå®æ•°æ®ï¼Œå…ˆç”¨â€œæš‚æ— è®°å½•â€æ›¿ä»£é»˜è®¤å€¼
                    };
                } catch (e) {
                    console.error('è·å–å…³å¡ä¿¡æ¯å¼‚å¸¸:', e);
                    // ç½‘ç»œé”™è¯¯æ—¶ï¼Œæ˜¾ç¤ºé€šç”¨æç¤º
                    this.showError('ç½‘ç»œå¼‚å¸¸ï¼Œæ— æ³•è·å–å…³å¡ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    throw e; // æŠ›å‡ºé”™è¯¯ï¼Œè®© initPage å¤„ç†åç»­
                }
            }
            
            // ç»‘å®šäº‹ä»¶
            bindEvents() {
                this.refreshBtn.addEventListener('click', () => this.loadRankData());
            }
            
            // æ›´æ–°å…³å¡ä¿¡æ¯æ˜¾ç¤º
            // æ›´æ–°å…³å¡ä¿¡æ¯æ˜¾ç¤º
updateLevelInfo() {
    // 1. ç¡®ä¿ levelData å’Œ DOM å…ƒç´ éƒ½å­˜åœ¨
    if (!this.levelData || !this.currentLevelName || !this.currentLevelDetails) {
        console.warn('å…³å¡æ•°æ®æˆ–DOMå…ƒç´ ç¼ºå¤±ï¼Œæ— æ³•æ›´æ–°ä¿¡æ¯');
        return;
    }
    
    // 2. æ¸²æŸ“å…³å¡åç§°ï¼ˆçœŸå®åç§°ï¼Œå¦‚â€œæ£®æ—æ¢é™©â€ï¼‰
    this.currentLevelName.textContent = this.levelData.name;
    
    // 3. æ¸²æŸ“éš¾åº¦ã€å—æ•°ã€æœ€ä½³è®°å½•ï¼ˆæ ¼å¼ç»Ÿä¸€ï¼‰
    this.currentLevelDetails.textContent = 
        `éš¾åº¦: ${this.levelData.difficulty} | æ‹¼å›¾å—æ•°: ${this.levelData.pieceCount} | æœ€ä½³è®°å½•: ${this.levelData.bestRecord}`;
}
            
            // åŠ è½½æ’åæ•°æ®
            async loadRankData() {
                this.showLoading();
                
                try {
                    // è°ƒç”¨APIè·å–æ’åæ•°æ®
                    const response = await fetch(`/ranking/by-level/${this.levelId}`);
                    const result = await response.json();
                    
                    if (result.code === 200 && result.data) {
                        // å¤„ç†æ’åæ•°æ®ï¼Œæ£€æŸ¥å½“å‰ç”¨æˆ·
                        const rankingData = result.data;
                        
                        // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œåº”è¯¥æ ¹æ®ç”¨æˆ·ç™»å½•çŠ¶æ€åˆ¤æ–­æ˜¯å¦æ˜¯å½“å‰ç”¨æˆ·
                        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå‡è®¾æ²¡æœ‰ç™»å½•çŠ¶æ€
                        
                        this.displayRankList(rankingData);
                        this.hideAll();
                        this.rankTableContainer.style.display = 'block';
                        this.myRankCard.style.display = 'block';
                    } else {
                        console.error('è·å–æ’åæ•°æ®å¤±è´¥:', result.msg);
                        this.showError();
                    }
                } catch (e) {
                    console.error('åŠ è½½æ’åæ•°æ®å¼‚å¸¸:', e);
                    this.showError();
                }
            }
            
            // æ˜¾ç¤ºæ’ååˆ—è¡¨
            displayRankList(list) {
                this.rankTableBody.innerHTML = '';
                
                list.forEach(p => {
                    const isTop3 = p.rank <= 3;
                    
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td><span class="rank-number ${isTop3 ? 'top3' : ''} ${isTop3 ? `rank-${p.rank}` : ''}">${p.rank}</span></td>
                        <td><span class="player-name ${isTop3 ? 'top3' : ''}">${p.username}</span></td>
                        <td><span class="time-display ${isTop3 ? 'top3' : ''}">${this.formatTime(p.totalTime)}</span></td>
                        <td><span class="steps-display ${isTop3 ? 'top3' : ''}">${p.totalSteps}</span></td>`;
                    
                    // å®é™…åº”ç”¨ä¸­å¯ä»¥æ ¹æ®ç™»å½•çŠ¶æ€åˆ¤æ–­å½“å‰ç”¨æˆ·
                    // if (isCurrentUser) {
                    //     row.className = 'current-user-row';
                    // }
                    
                    this.rankTableBody.appendChild(row);
                });
                
                // æ›´æ–°æˆ‘çš„æ’åä¿¡æ¯
                // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œåº”è¯¥è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„IDå¹¶åœ¨åˆ—è¡¨ä¸­æŸ¥æ‰¾
                // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œæš‚æ—¶ä¸æ˜¾ç¤ºæˆ‘çš„æ’åä¿¡æ¯
                if (list.length > 0) {
                    // å¯ä»¥è®¾ç½®ä¸€ä¸ªé»˜è®¤å€¼æˆ–éšè—ç›¸å…³å…ƒç´ 
                    document.getElementById('myRank').textContent = '-';
                    document.getElementById('myTotalTime').textContent = '00:00:00';
                    document.getElementById('myTotalSteps').textContent = '0';
                }
            }
            
            // æ ¼å¼åŒ–æ—¶é—´
            formatTime(s) {
                const h = Math.floor(s / 3600);
                const m = Math.floor((s % 3600) / 60);
                const sec = s % 60;
                return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showLoading() {
                this.hideAll();
                this.loadingMessage.style.display = 'block';
                this.refreshBtn.disabled = true;
            }
            
            // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
            // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€ï¼ˆæ”¯æŒè‡ªå®šä¹‰æç¤ºï¼‰
showError(customMsg = 'âŒ åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•') {
    this.hideAll(); // éšè—æ‰€æœ‰å…¶ä»–å†…å®¹
    this.errorMessage.textContent = customMsg; // æ˜¾ç¤ºè‡ªå®šä¹‰é”™è¯¯
    this.errorMessage.style.display = 'block';
    this.refreshBtn.disabled = false; // å¯ç”¨åˆ·æ–°æŒ‰é’®ï¼Œå…è®¸é‡è¯•
}
            
            // æ˜¾ç¤ºç©ºæ•°æ®çŠ¶æ€
            showEmpty() {
                this.hideAll();
                this.emptyMessage.style.display = 'block';
                this.refreshBtn.disabled = false;
            }
            
            // éšè—æ‰€æœ‰çŠ¶æ€
            hideAll() {
                this.loadingMessage.style.display = 'none';
                this.errorMessage.style.display = 'none';
                this.emptyMessage.style.display = 'none';
                this.rankTableContainer.style.display = 'none';
                this.myRankCard.style.display = 'none';
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            new LevelRankPage();
        });
    </script>
    
    <!-- å¸®åŠ©é¡µé¢æ¨¡æ€æ¡† -->
    <div class="modal-mask" id="helpModal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <span>æ“ä½œæŒ‡å—</span>
                <span class="modal-close" onclick="document.getElementById('helpModal').style.display='none'">Ã—</span>
            </div>
            <div class="modal-body" style="font-size: 14px; line-height: 24px; color: #E0E0E0;">
                <p><strong style="color: #F9E078;">1. æ¸¸æˆæ“ä½œ</strong></p>
                <p>- é¼ æ ‡å·¦é”®é•¿æŒ‰å›¾å—ï¼Œæ‹–æ‹½åˆ°æ‹¼å›¾åŒºåŸŸ</p>
                <p>- å•å‡»é€‰ä¸­çš„å›¾å—ï¼Œé¡ºæ—¶é’ˆæ—‹è½¬90åº¦</p>
                <p>- ç‚¹å‡»"æ’¤é”€"å¯è¿˜åŸä¸Šä¸€æ­¥æ“ä½œï¼Œ"é‡åš"æ¢å¤æ’¤é”€æ“ä½œ</p>
                <p><strong style="color: #F9E078; margin-top: 16px; display: block;">2. è‡ªå®šä¹‰æ‹¼å›¾</strong></p>
                <p>- æ”¯æŒä¸Šä¼ æœ¬åœ°å›¾ç‰‡ï¼ˆJPG/PNGï¼Œæœ€å¤§5MBï¼‰ï¼Œå¯è£å‰ªè°ƒæ•´</p>
                <p>- å¯è®¾ç½®æ‹¼å›¾å—æ•°ï¼ˆ4-64å—ï¼‰ã€å½¢çŠ¶ï¼ˆçŸ©å½¢/å¼‚å½¢ï¼‰ã€æ˜¯å¦æ—‹è½¬</p>
                <p><strong style="color: #F9E078; margin-top: 16px; display: block;">3. å­˜æ¡£ä¸åˆ†äº«</strong></p>
                <p>- ç™»å½•ç”¨æˆ·å­˜æ¡£åŒæ­¥è‡³æœåŠ¡å™¨ï¼Œæ¸¸å®¢å­˜æ¡£ä»…ä¿å­˜åœ¨å½“å‰æµè§ˆå™¨</p>
                <p>- è‡ªå®šä¹‰æ‹¼å›¾å¯åˆ†äº«è‡³"åˆ†äº«ä¸­å¿ƒ"ï¼Œä¾›å…¶ä»–ç©å®¶æ¸¸ç©</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="document.getElementById('helpModal').style.display='none'">æˆ‘çŸ¥é“äº†</button>
            </div>
        </div>
    </div>
    
    <!-- é¡µé¢ç‰¹å®šçš„èƒŒæ™¯éŸ³ä¹ -->
    <script>
        // ç­‰å¾…éŸ³ä¹ç®¡ç†å™¨åŠ è½½å®Œæˆ
        function initPageMusic() {
            if (window.musicManager) {
                // æ’è¡Œæ¦œé¡µé¢è‡ªåŠ¨æ’­æ”¾ä¸»ç•Œé¢éŸ³ä¹
                window.musicManager.playScene('main');
            } else {
                // å¦‚æœéŸ³ä¹ç®¡ç†å™¨å°šæœªåŠ è½½ï¼Œç¨åé‡è¯•
                setTimeout(initPageMusic, 100);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåç›´æ¥åˆå§‹åŒ–éŸ³ä¹ï¼Œæ— éœ€ç­‰å¾…ç”¨æˆ·äº¤äº’
        document.addEventListener('DOMContentLoaded', function() {
            // ç›´æ¥å°è¯•æ’­æ”¾éŸ³ä¹
            initPageMusic();
        });
    </script>
</body>
</html>