<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹¼å›¾æ¸¸æˆ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/game-rank.css') }}">
</head>
<body>
{% include '_navbar.html' %}
<div class="background-blur"></div>
<div class="container">
    <h1>æ‹¼å›¾æ¸¸æˆ</h1>
    <div class="controls">
        <button id="toggleBgBtn" class="btn">éšè—èƒŒæ™¯</button>
        <button id="undoBtn" class="btn">æ’¤é”€</button>
    </div>
    <div class="game-info">
        <div id="timer">æ—¶é—´: 00:00</div>
        <div id="moves">ç§»åŠ¨æ¬¡æ•°: 0</div>
        <div id="opponentMovesBox">
            å¯¹æ‰‹ç§»åŠ¨æ¬¡æ•°: <span id="opponentMoves">0</span>
            ï¼Œæ­£ç¡®å—æ•°: <span id="opponentCorrect">0</span>
        </div>
    </div>
    <div class="puzzle-container">
        <div class="puzzle-board-wrapper">
            <div id="puzzleBg" class="puzzle-bg"></div>
            <div id="puzzleBoard" class="puzzle-board"></div>
        </div>
        <div id="piecesZone" class="pieces-zone"></div>
    </div>
    <div id="gameComplete" class="game-complete">
        <div class="message">
            <h2>æ­å–œï¼æ‹¼å›¾å®Œæˆï¼</h2>
            <p id="completeInfo"></p>
            <button id="playAgainBtn" class="btn">å†ç©ä¸€æ¬¡</button>
        </div>
    </div>
</div>

<!-- å¸®åŠ©é¡µé¢æ¨¡æ€æ¡† -->
<div class="modal-mask" id="helpModal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <span>æ“ä½œæŒ‡å—</span>
            <span class="modal-close" onclick="closeHelpModal()">Ã—</span>
        </div>
        <div class="modal-body" style="font-size: 14px; line-height: 24px; color: #E0E0E0;">
            <p><strong style="color: #F9E078;">1. æ¸¸æˆæ“ä½œ</strong></p>
            <p>- é¼ æ ‡å·¦é”®é•¿æŒ‰å›¾å—ï¼Œæ‹–æ‹½åˆ°æ‹¼å›¾åŒºåŸŸ</p>
            <p>- å•å‡»é€‰ä¸­çš„å›¾å—ï¼Œé¡ºæ—¶é’ˆæ—‹è½¬90åº¦</p>
            <p>- ç‚¹å‡»"æ’¤é”€"å¯è¿˜åŸä¸Šä¸€æ­¥æ“ä½œï¼Œ"é‡åš"æ¢å¤æ’¤é”€æ“ä½œ</p>
            <p><strong style="color: #F9E078; margin-top: 16px; display: block;">2. è‡ªå®šä¹‰æ‹¼å›¾</strong></p>
            <p>- æ”¯æŒä¸Šä¼ æœ¬åœ°å›¾ç‰‡ï¼ˆJPG/PNGï¼Œæœ€å¤§5MBï¼‰ï¼Œå¯è£å‰ªè°ƒæ•´</p>
            <p>- å¯è®¾ç½®æ‹¼å›¾å—æ•°ï¼ˆ4-64å—ï¼‰ã€å½¢çŠ¶ï¼ˆçŸ©å½¢/å¼‚å½¢ï¼‰ã€æ˜¯å¦æ—‹è½¬</p>
            <p><strong style="color: #F9E078; margin-top: 16px; display: block;">3. å­˜æ¡£ä¸åˆ†äº«</strong></p>
            <p>- ç™»å½•ç”¨æˆ·å­˜æ¡£åŒæ­¥è‡³æœåŠ¡å™¨ï¼Œæ¸¸å®¢å­˜æ¡£ä»…ä¿å­˜åœ¨å½“å‰æµè§ˆå™¨</p>
            <p>- è‡ªå®šä¹‰æ‹¼å›¾å¯åˆ†äº«è‡³"åˆ†äº«ä¸­å¿ƒ"ï¼Œä¾›å…¶ä»–ç©å®¶æ¸¸ç©</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="closeHelpModal()">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>
</div>
<svg width="0" height="0" style="position: absolute; z-index: -1;">
  <defs id="puzzle-defs"></defs>
</svg>
<script src="{{ url_for('static', filename='js/online_game.js') }}"></script>
<script src="{{ url_for('static', filename='js/online_script.js') }}"></script>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
// æ¸¸æˆæš‚åœ/ç»§ç»­åŠŸèƒ½
let gamePaused = false;
let gameInstance = null;

// ç­‰å¾…æ¸¸æˆå®ä¾‹åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        if (window.puzzleGame) {
            gameInstance = window.puzzleGame;
        }
    }, 100);
});

// æ‰“å¼€å¸®åŠ©æ¨¡æ€æ¡†æ—¶æš‚åœæ¸¸æˆ
function openHelpModal() {
    const helpModal = document.getElementById('helpModal');
    if (helpModal) {
        helpModal.style.display = 'flex';
        if (gameInstance && gameInstance.gameStarted && !gamePaused) {
            gameInstance.pauseGame();
            gamePaused = true;
        }
    }
}

// å…³é—­å¸®åŠ©æ¨¡æ€æ¡†æ—¶ç»§ç»­æ¸¸æˆ
function closeHelpModal() {
    const helpModal = document.getElementById('helpModal');
    if (helpModal) {
        helpModal.style.display = 'none';
        if (gameInstance && gamePaused) {
            gameInstance.resumeGame();
            gamePaused = false;
        }
    }
}

// é‡å†™å¯¼èˆªæ çš„å¸®åŠ©æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆä»…é™gameé¡µé¢ï¼‰
document.addEventListener('DOMContentLoaded', function() {
    const helpLink = document.getElementById('pm-help-link');
    if (helpLink) {
        helpLink.onclick = null;
        helpLink.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            openHelpModal();
        });
    }
    const piecesZone = document.getElementById('piecesZone');
    if (piecesZone) {
        piecesZone.addEventListener('wheel', function(event) {
            const hasHorizontalScrollbar = piecesZone.scrollWidth > piecesZone.clientWidth;
            if (hasHorizontalScrollbar) {
                event.preventDefault();
                let scrollAmount = event.deltaY;
                if (scrollAmount === 0 && event.deltaX !== 0) {
                    scrollAmount = event.deltaX;
                }
                piecesZone.scrollLeft += scrollAmount;
            }
        }, { passive: false });
    }
});

// é¡µé¢ç‰¹å®šçš„èƒŒæ™¯éŸ³ä¹
function initPageMusic() {
    if (window.musicManager) {
        window.musicManager.playScene('game');
    } else {
        setTimeout(initPageMusic, 100);
    }
}
document.addEventListener('DOMContentLoaded', function() {
    initPageMusic();
});

// Socket.IO è¿æ¥ä¸å¯¹æ‰‹æ­¥æ•°/æ­£ç¡®å—æ•°ç›‘å¬
async function joinRoomWithAuth() {
    if (!window.socket) {
        window.socket = io();
    }
    const roomId = new URLSearchParams(window.location.search).get('room_id');
    // ç”¨ /auth/me è·å–ç”¨æˆ·å
    let username = 'ç©å®¶';
    const token = localStorage.getItem('puzzleToken');
    if (token) {
        try {
            const res = await fetch('/auth/me', { headers: { 'Authorization': 'Bearer ' + token } });
            const data = await res.json();
            if (data.code === 200 && data.data && data.data.username) {
                username = data.data.username;
            }
        } catch (e) {}
    }
    window.socket.emit('join_room', { room_id: roomId, username });
}
joinRoomWithAuth();
window.socket.on('opponent_moves', function(data) {
    document.getElementById('opponentMoves').textContent = data.moves;
    document.getElementById('opponentCorrect').textContent = data.correct;
});

// æ‹‰å–æˆ¿é—´æ‹¼å›¾æ•°æ®å¹¶åˆå§‹åŒ–æ¸¸æˆ
document.addEventListener('DOMContentLoaded', function() {
    const roomId = new URLSearchParams(window.location.search).get('room_id');
    if (roomId) {
        fetch(`/pvp/room_info?room_id=${roomId}`)
            .then(res => res.json())
            .then(data => {
                if (data.code === 200) {
                    window.puzzleGame && window.puzzleGame.init({
                        img: '/static/uploads/' + data.image,
                        ...data.config
                    });
                } else {
                    alert('æ²¡æœ‰æ‰¾åˆ°æ‹¼å›¾æ•°æ®ï¼Œè¯·ä»é¢„è§ˆé¡µé¢å¼€å§‹æ¸¸æˆã€‚');
                    window.location.href = '/versus';
                }
            })
            .catch(err => {
                alert('ç½‘ç»œé”™è¯¯: ' + err);
                window.location.href = '/versus';
            });
    }
});

// ç»Ÿä¸€ç”¨ /auth/me è·å–ç”¨æˆ·åï¼Œä¿è¯å’Œåç«¯ä¸€è‡´
async function getMyUsername() {
    const token = localStorage.getItem('puzzleToken');
    if (!token) return 'ç©å®¶';
    try {
        const res = await fetch('/auth/me', { headers: { 'Authorization': 'Bearer ' + token } });
        const data = await res.json();
        if (data.code === 200 && data.data && data.data.username) {
            return data.data.username;
        }
    } catch (e) {}
    return 'ç©å®¶';
}

window.socket.on('pvp_game_over', async function(data) {
    // data: { winner, loser }
    let myName = await getMyUsername();
    const isWinner = data.loser !=== myName;
    const opponentName = isWinner ? data.loser : data.winner;
    console.log(opponentName);
    // è·å–æœ¬åœ°æ­¥æ•°å˜é‡
    let myMoves = 0, opponentMoves = 0;
    if (window.puzzleGame && typeof window.puzzleGame.moveCount === 'number') {
        myMoves = window.puzzleGame.moveCount;
    } else {
        myMoves = window.moveCount || 0;
    }
    // å¯¹æ‰‹æ­¥æ•°ç”¨é¡µé¢å®æ—¶å˜é‡
    const oppMovesElem = document.getElementById('opponentMoves');
    if (oppMovesElem) {
        opponentMoves = parseInt(oppMovesElem.textContent) || 0;
    }

    let msg = '';
    if (isWinner) {
        msg = `ğŸ‰ ä½ èµ¢äº†ï¼<br>
        <span style="font-size:1rem;">ä½ çš„æ­¥æ•°: <b>${myMoves}</b></span><br>
        <span style="font-size:1rem;">å¯¹æ‰‹ï¼ˆ${opponentName}ï¼‰æ­¥æ•°: <b>${opponentMoves}</b></span>`;
    } else {
        msg = `ğŸ˜¢ ä½ è¾“äº†ï¼<br>
        <span style="font-size:1rem;">ä½ çš„æ­¥æ•°: <b>${myMoves}</b></span><br>
        <span style="font-size:1rem;">å¯¹æ‰‹ï¼ˆ${opponentName}ï¼‰æ­¥æ•°: <b>${opponentMoves}</b></span>`;
    }

    const winDiv = document.createElement('div');
    winDiv.style.position = 'fixed';
    winDiv.style.top = '50%';
    winDiv.style.left = '50%';
    winDiv.style.transform = 'translate(-50%, -50%)';
    winDiv.style.background = 'rgba(0,0,0,0.9)';
    winDiv.style.color = '#fff';
    winDiv.style.padding = '2rem';
    winDiv.style.borderRadius = '12px';
    winDiv.style.fontSize = '1.5rem';
    winDiv.style.zIndex = 9999;
    winDiv.innerHTML = `<div style="text-align:center;">${msg}</div>
        <button id="exitRoomBtn" style="margin-top:1.5rem;font-size:1rem;">é€€å‡ºæˆ¿é—´</button>`;
    document.body.appendChild(winDiv);

    document.getElementById('exitRoomBtn').onclick = function() {
        const roomId = new URLSearchParams(window.location.search).get('room_id');
        window.socket.emit('leave_room', { room_id: roomId, username: myName });
        window.location.href = '/menu';
    };
});
</script>
</body>
</html>