<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="email=no">
    <meta name="format-detection" content="address=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#20223A">
    <title>æ‹¼å›¾å¤§å¸ˆ - é€‰æ‹©å…³å¡</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mobile.css') }}">
</head>
<body>
{% include '_navbar.html' %}
<div class="container" style="max-width: 1200px; margin: 0 auto;">
    <div class="background-blur"></div>
    <div class="page-title" style="margin-top: 20px;">
        <button class="btn btn-secondary back-btn" onclick="window.location.href='{{ url_for('main') }}';" style="padding: 8px 16px; font-size: 12px; margin-right: 16px;">
            <span class="chinese-text">è¿”å›</span>
        </button>
        <span class="chinese-text" style="color: #F9E078; font-size: 18px;">é€‰æ‹©å…³å¡</span>
    </div>

    <div class="filter-area card" style="margin-bottom: 24px; background-color:#20223A;">
        <div style="display: flex; flex-wrap: wrap; gap: 20px;">
            <div style="flex: 1; min-width: 200px;">
                <label class="filter-section-label">é£æ ¼ç­›é€‰</label>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <label class="filter-label active" data-filter="style" data-value="all" style="padding: 8px 16px; border-radius: 0; cursor: pointer; background-color: #F9E078; color: #20223A; border: 2px solid #F9E078; box-shadow: 3px 3px 0 #000000; font-family: 'Press Start 2P', 'Zpix', monospace; font-size: 12px; transition: all 0.1s ease;">å…¨éƒ¨</label>
                    <label class="filter-label" data-filter="style" data-value="nature" style="padding: 8px 16px; border-radius: 0; cursor: pointer; border: 2px solid #F9E078; background: #20223A; color: #F9E078; box-shadow: 3px 3px 0 #000000; font-family: 'Press Start 2P', 'Zpix', monospace; font-size: 12px; transition: all 0.1s ease;">è‡ªç„¶é£å…‰</label>
                    <label class="filter-label" data-filter="style" data-value="animal" style="padding: 8px 16px; border-radius: 0; cursor: pointer; border: 2px solid #F9E078; background: #20223A; color: #F9E078; box-shadow: 3px 3px 0 #000000; font-family: 'Press Start 2P', 'Zpix', monospace; font-size: 12px; transition: all 0.1s ease;">åŠ¨ç‰©</label>
                    <label class="filter-label" data-filter="style" data-value="building" style="padding: 8px 16px; border-radius: 0; cursor: pointer; border: 2px solid #F9E078; background: #20223A; color: #F9E078; box-shadow: 3px 3px 0 #000000; font-family: 'Press Start 2P', 'Zpix', monospace; font-size: 12px; transition: all 0.1s ease;">å»ºç­‘</label>
                    <label class="filter-label" data-filter="style" data-value="cartoon" style="padding: 8px 16px; border-radius: 0; cursor: pointer; border: 2px solid #F9E078; background: #20223A; color: #F9E078; box-shadow: 3px 3px 0 #000000; font-family: 'Press Start 2P', 'Zpix', monospace; font-size: 12px; transition: all 0.1s ease;">å¡é€š</label>
                </div>
            </div>
            <div style="flex: 1; min-width: 200px;">
                <label class="filter-section-label">éš¾åº¦ç­›é€‰</label>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <label class="filter-label active" data-filter="difficulty" data-value="all" style="padding: 8px 16px; border-radius: 0; cursor: pointer; background-color: #F9E078; color: #20223A; border: 2px solid #F9E078; box-shadow: 3px 3px 0 #000000; font-family: 'Press Start 2P', 'Zpix', monospace; font-size: 12px; transition: all 0.1s ease;">å…¨éƒ¨</label>
                    <label class="filter-label" data-filter="difficulty" data-value="3" style="padding: 8px 16px; border-radius: 0; cursor: pointer; border: 2px solid #F9E078; background: #20223A; color: #F9E078; box-shadow: 3px 3px 0 #000000; font-family: 'Press Start 2P', 'Zpix', monospace; font-size: 12px; transition: all 0.1s ease;">ç®€å•<span class="symbol-text">ï¼ˆ</span><span class="number-text">3</span><span class="symbol-text">Ã—</span><span class="number-text">3</span><span class="symbol-text">ï¼‰</span></label>
                    <label class="filter-label" data-filter="difficulty" data-value="4" style="padding: 8px 16px; border-radius: 0; cursor: pointer; border: 2px solid #F9E078; background: #20223A; color: #F9E078; box-shadow: 3px 3px 0 #000000; font-family: 'Press Start 2P', 'Zpix', monospace; font-size: 12px; transition: all 0.1s ease;">ä¸­ç­‰<span class="symbol-text">ï¼ˆ</span><span class="number-text">4</span><span class="symbol-text">Ã—</span><span class="number-text">4</span><span class="symbol-text">ï¼‰</span></label>
                    <label class="filter-label" data-filter="difficulty" data-value="5" style="padding: 8px 16px; border-radius: 0; cursor: pointer; border: 2px solid #F9E078; background: #20223A; color: #F9E078; box-shadow: 3px 3px 0 #000000; font-family: 'Press Start 2P', 'Zpix', monospace; font-size: 12px; transition: all 0.1s ease;">å›°éš¾<span class="symbol-text">ï¼ˆ</span><span class="number-text">5</span><span class="symbol-text">Ã—</span><span class="number-text">5</span><span class="symbol-text">ï¼‰</span></label>
                </div>
            </div>
        </div>
    </div>

    <div class="level-list" id="levelList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-bottom: 80px;"></div>

    <!-- å›ºå®šåº•éƒ¨è¿›å…¥æ¸¸æˆæŒ‰é’® -->
    <div id="fixedGameBtn" style="position: fixed; bottom: 0; left: 0; right: 0; background-color: #20223A; border-top: 2px solid #F9E078; padding: 15px; text-align: center; z-index: 1000; display: none;">
        <button id="enterGameBtn" class="btn btn-primary" style="padding: 12px 40px; font-size: 14px;" disabled>
            <span class="chinese-text">è¿›å…¥æ¸¸æˆ</span>
        </button>
    </div>
</div>

<!-- å¸®åŠ©é¡µé¢æ¨¡æ€æ¡† -->
<div class="modal-mask" id="helpModal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <span>æ“ä½œæŒ‡å—</span>
            <span class="modal-close" onclick="document.getElementById('helpModal').style.display='none'">Ã—</span>
        </div>
        <div class="modal-body" style="font-size: 14px; line-height: 24px; color: #E0E0E0;">
            <!-- æ¡Œé¢ç«¯æ“ä½œæŒ‡å— -->
            <div id="desktop-help" style="display: none;">
                <p><strong style="color: #F9E078;">1. é€‰æ‹©å…³å¡</strong></p>
                <p>- æµè§ˆä¸åŒé£æ ¼çš„æ‹¼å›¾ï¼šè‡ªç„¶é£å…‰ã€åŠ¨ç‰©ã€å»ºç­‘ã€å¡é€š</p>
                <p>- é€‰æ‹©é€‚åˆçš„éš¾åº¦ï¼šç®€å•(3Ã—3)ã€ä¸­ç­‰(4Ã—4)ã€å›°éš¾(5Ã—5)</p>
                <p>- ç‚¹å‡»å…³å¡å¡ç‰‡æŸ¥çœ‹é¢„è§ˆå›¾</p>
                <p><strong style="color: #F9E078; margin-top: 16px; display: block;">2. ç­›é€‰åŠŸèƒ½</strong></p>
                <p>- ä½¿ç”¨é£æ ¼ç­›é€‰å¿«é€Ÿæ‰¾åˆ°å–œæ¬¢çš„å›¾ç‰‡ç±»å‹</p>
                <p>- ä½¿ç”¨éš¾åº¦ç­›é€‰é€‰æ‹©åˆé€‚çš„æŒ‘æˆ˜çº§åˆ«</p>
                <p>- ç‚¹å‡»"å…¨éƒ¨"å¯ä»¥æ¸…é™¤ç­›é€‰æ¡ä»¶</p>
                <p><strong style="color: #F9E078; margin-top: 16px; display: block;">3. å¼€å§‹æ¸¸æˆ</strong></p>
                <p>- é€‰æ‹©å…³å¡åç‚¹å‡»"è¿›å…¥æ¸¸æˆ"æŒ‰é’®</p>
                <p>- ç³»ç»Ÿä¼šè‡ªåŠ¨åŠ è½½é€‰å®šçš„æ‹¼å›¾</p>
            </div>
            
            <!-- ç§»åŠ¨ç«¯æ“ä½œæŒ‡å— -->
            <div id="mobile-help" style="display: none;">
                <p><strong style="color: #F9E078;">ğŸ“± ç§»åŠ¨ç«¯å…³å¡é€‰æ‹©</strong></p>
                <p><strong style="color: #F9E078;">1. æµè§ˆå…³å¡</strong></p>
                <p>- ä¸Šä¸‹æ»‘åŠ¨æµè§ˆä¸åŒé£æ ¼çš„æ‹¼å›¾</p>
                <p>- ç‚¹å‡»å…³å¡å¡ç‰‡æŸ¥çœ‹å¤§å›¾é¢„è§ˆ</p>
                <p>- æ”¯æŒè‡ªç„¶é£å…‰ã€åŠ¨ç‰©ã€å»ºç­‘ã€å¡é€šç­‰é£æ ¼</p>
                <p><strong style="color: #F9E078; margin-top: 16px; display: block;">2. éš¾åº¦é€‰æ‹©</strong></p>
                <p>- ç®€å•(3Ã—3)ï¼šé€‚åˆæ–°æ‰‹ï¼Œ9å—æ‹¼å›¾</p>
                <p>- ä¸­ç­‰(4Ã—4)ï¼šç»å…¸éš¾åº¦ï¼Œ16å—æ‹¼å›¾</p>
                <p>- å›°éš¾(5Ã—5)ï¼šé«˜éš¾åº¦æŒ‘æˆ˜ï¼Œ25å—æ‹¼å›¾</p>
                <p><strong style="color: #F9E078; margin-top: 16px; display: block;">3. ç­›é€‰åŠŸèƒ½</strong></p>
                <p>- ç‚¹å‡»ç­›é€‰æ ‡ç­¾å¿«é€Ÿæ‰¾åˆ°æƒ³è¦çš„å…³å¡</p>
                <p>- å¯ä»¥åŒæ—¶ä½¿ç”¨é£æ ¼å’Œéš¾åº¦ç­›é€‰</p>
                <p><strong style="color: #F9E078; margin-top: 16px; display: block;">4. å¼€å§‹æ¸¸æˆ</strong></p>
                <p>- é€‰æ‹©å–œæ¬¢çš„å…³å¡åç‚¹å‡»åº•éƒ¨"è¿›å…¥æ¸¸æˆ"</p>
                <p>- ç³»ç»Ÿä¼šè‡ªåŠ¨è·³è½¬åˆ°æ¸¸æˆç•Œé¢</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="document.getElementById('helpModal').style.display='none'">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>
</div>

<script>
let selectedLevelId = '';
let selectedImage = '';
let selectedDifficulty = 3;
let currentStyleFilter = 'all';
let currentDifficultyFilter = 'all';

// æ•°æ®åº“éš¾åº¦/å±•ç¤ºæ˜ å°„
const diffColorMap = { easy: '#52C41A', medium: '#FAAD14', hard: '#FF4D4F' };
const diffTextMap = { easy: 'ç®€å•', medium: 'ä¸­ç­‰', hard: 'å›°éš¾' };
const gridMapByDifficulty = { easy: 4, medium: 5, hard: 6 };

// ä»æ•°æ®åº“æ¸²æŸ“å…³å¡
function renderLevels(levels){
    const list = document.getElementById('levelList');
    list.innerHTML = '';
    if(!levels || !levels.length){
        list.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#B8BCC8; padding:20px;">æš‚æ— ç³»ç»Ÿå…³å¡</div>' +
                         '<div style="grid-column:1/-1; text-align:center; padding:8px;">' +
                         '<a href="' + ("{{ url_for('editor_page') }}") + '" class="btn btn-primary">å»åˆ›å»ºæ‹¼å›¾</a>' +
                         '</div>';
        return;
    }
    levels.forEach(item => {
        const type = (item.type||'other');
        const diffKey = String(item.difficulty||'easy').toLowerCase();
        const diffColor = diffColorMap[diffKey] || '#52C41A';
        const diffText = diffTextMap[diffKey] || 'ç®€å•';
        const gridVal = gridMapByDifficulty[diffKey] || 4;
        const card = document.createElement('div');
        card.className = 'level-card card';
        card.setAttribute('data-style', type);
        card.setAttribute('data-difficulty', diffKey === 'easy' ? '3' : diffKey === 'medium' ? '4' : '5');
        card.style.cssText = 'cursor:pointer; position:relative; background-color:#20223A;';
        card.onclick = (e) => selectLevel(item.puzzle_id || item.level_id || item.title, item.image_url, gridVal);
        card.innerHTML = `
            <div style="position: relative; margin-bottom: 12px;">
                <img src="${item.image_url}" alt="${item.title||''}" style="width: 100%; height: 140px; object-fit: cover; border-radius: 4px;">
                <span style="position: absolute; top: 8px; left: 8px; background-color: ${diffColor}; color: #FFF; font-size: 12px; padding: 2px 8px; border-radius: 4px;">${diffText}</span>
            </div>
            <h3 style="font-size: 16px; margin-bottom: 8px;">${item.title||''} - ${diffText}</h3>
            <div style="font-size: 12px; color: #B8BCC8;">æœªæŒ‘æˆ˜è¯¥éš¾åº¦</div>
        `;
        list.appendChild(card);
    });
    applyFilters();
}

async function loadSystemLevels(){
    try{
        const r = await fetch('/pic/levels/system');
        const j = await r.json();
        if(j && j.code === 200){
            renderLevels(j.data || []);
        }else{
            document.getElementById('levelList').innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#FF4D4F; padding:20px;">åŠ è½½å¤±è´¥</div>';
        }
    }catch(e){
        document.getElementById('levelList').innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#FF4D4F; padding:20px;">ç½‘ç»œé”™è¯¯</div>';
    }
}

// ç­›é€‰åŠŸèƒ½
function applyFilters() {
    const levelCards = document.querySelectorAll('.level-card');
    levelCards.forEach(card => {
        const cardStyle = card.getAttribute('data-style');
        const cardDifficulty = card.getAttribute('data-difficulty');
        let showCard = true;
        if (currentStyleFilter !== 'all' && cardStyle !== currentStyleFilter) showCard = false;
        if (currentDifficultyFilter !== 'all' && cardDifficulty !== currentDifficultyFilter) showCard = false;
        card.style.display = showCard ? 'block' : 'none';
    });
}

// ç­›é€‰æŒ‰é’®ç‚¹å‡»äº‹ä»¶
document.querySelectorAll('.filter-label').forEach(label => {
    label.addEventListener('click', () => {
        const filterType = label.getAttribute('data-filter');
        const filterValue = label.getAttribute('data-value');
        const parent = label.parentElement;
        parent.querySelectorAll('.filter-label').forEach(btn => {
            btn.classList.remove('active');
            btn.style.backgroundColor = '#20223A';
            btn.style.color = '#F9E078';
        });
        label.classList.add('active');
        label.style.backgroundColor = '#F9E078';
        label.style.color = '#20223A';
        if (filterType === 'style') currentStyleFilter = filterValue;
        else if (filterType === 'difficulty') currentDifficultyFilter = filterValue;
        applyFilters();
    });
});

// é€‰æ‹©å…³å¡
function selectLevel(id, image, difficulty) {
    selectedLevelId = id;
    selectedImage = image;
    selectedDifficulty = difficulty;
    document.querySelectorAll('.level-card').forEach(card => { card.style.border = '1px solid #E5E7EB'; });
    event.currentTarget.style.border = '2px solid #F9E078';
    document.getElementById('fixedGameBtn').style.display = 'block';
    document.getElementById('enterGameBtn').disabled = false;
}

// è¿›å…¥æ¸¸æˆ
document.getElementById('enterGameBtn').addEventListener('click', () => {
    // è®°å½•å½“å‰å…³å¡IDï¼ˆç”¨äºä¿å­˜/æ¢å¤è¿›åº¦æ¥å£ï¼‰
    if (selectedLevelId) {
        localStorage.setItem('puzzleId', String(selectedLevelId));
        localStorage.setItem('isSystemLevel', 'true');
    }
    localStorage.setItem('customImage', selectedImage);
    localStorage.setItem('customSize', selectedDifficulty);
    window.location.href = '{{ url_for('game_page') }}';
});

// é¡µé¢åŠ è½½
 document.addEventListener('DOMContentLoaded', function() {
    loadSystemLevels();
    loadUserLevelRecords();
});

// åŠ è½½ç”¨æˆ·å…³å¡è®°å½•ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ä»¥å±•ç¤ºæœ€ä½³æˆç»©ç­‰ï¼‰
function loadUserLevelRecords() {
    const token = localStorage.getItem('puzzleToken');
    if (!token) return;
    fetch('/levels/records', {
        method: 'GET',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.code === 200) updateLevelCards(data.data);
    })
    .catch(() => {});
}

// æ›´æ–°å…³å¡å¡ç‰‡æ˜¾ç¤ºï¼ˆä¿ç•™åŸæœ‰æœ€ä½³æˆç»©æ¸²æŸ“ï¼‰
function updateLevelCards(records) {
    const levelCards = document.querySelectorAll('.level-card');
    levelCards.forEach(card => {
        const titleEl = card.querySelector('h3');
        const levelId = titleEl ? (titleEl.textContent||'').split(' - ')[0] : '';
        const record = records.find(r => r.level_id === levelId);
        if (record) {
            let statusElement = card.querySelector('div[style*="font-size: 12px;"]');
            if (statusElement) statusElement.textContent = record.status_text || 'å·²æŒ‘æˆ˜';
        }
    });
}
</script>
    <!-- é¡µé¢ç‰¹å®šçš„èƒŒæ™¯éŸ³ä¹ -->
    <script>
        function initPageMusic() {
            if (window.musicManager) {
                window.musicManager.playScene('main');
            } else {
                setTimeout(initPageMusic, 100);
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
            initPageMusic();
        });
    </script>

<script>
// ç§»åŠ¨ç«¯è®¾å¤‡æ£€æµ‹å’Œç±»æ·»åŠ 
(function() {
    'use strict';
    
    function isMobile() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
               window.innerWidth <= 768;
    }
    
    function addMobileClass() {
        if (isMobile()) {
            document.body.classList.add('mobile-device');
        }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', addMobileClass);
    } else {
        addMobileClass();
    }
    
    // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°æ£€æµ‹
    window.addEventListener('resize', function() {
        setTimeout(addMobileClass, 100);
    });
})();
</script>

</body>
</html>
