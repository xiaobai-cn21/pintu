<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="email=no">
    <meta name="format-detection" content="address=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#20223A">
    <title>æ‹¼å›¾é¢„è§ˆ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mobile.css') }}">
    <style>
        .preview-main { max-width: 900px; margin: 40px auto; display: flex; gap: 32px; flex-wrap: wrap; }
        .preview-left, .preview-right { flex: 1; min-width: 320px; }
        .preview-card { background: #20223A; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); padding: 24px; margin-bottom: 24px; }
        .preview-upload-box { border: 2px dashed #E5E7EB; border-radius: 8px; padding: 40px; text-align: center; cursor: pointer; }
        .preview-img { width: 100%; border-radius: 8px; display: block; margin-bottom: 12px; }
        .preview-grid-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .preview-img-box { position: relative; width: 100%; min-height: 240px; background: #20223A; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .preview-btn-row { text-align: center; margin-top: 24px; }
     /* æ–°å¢é€‰é¡¹æ ·å¼ */
        .random-options {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #2d3250;
        }
        .random-option-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .random-option-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #165DFF;
        }
        .random-option-item label {
            font-size: 14px;
            color: #E5E7EB;
            cursor: pointer;
        }
        .share-code {
            margin-top: 25px;
            font-size: 18px;
            font-weight: bold;
        }
    </style>
    
</head>
<body>
{% include '_navbar.html' %}

<div class="background-blur"></div>

    <div class="page-title" style="margin-top: 20px;">
        <button class="btn btn-secondary back-btn" onclick="window.location.href='{{ url_for('main') }}'" style="padding: 8px 16px; font-size: 12px; margin-right: 16px;">
            <span class="chinese-text">è¿”å›</span>
        </button>
        <span class="chinese-text" style="color: #F9E078; font-size: 18px;">åˆ›å»ºæ‹¼å›¾</span>
    </div>
    <div class="preview-main">
        <!-- å·¦ä¾§ï¼šä¸Šä¼ å’Œé…ç½® -->
        <div class="preview-left">
            <div class="preview-card">
                <h3 style="font-size: 16px; margin-bottom: 16px;">ä¸Šä¼ å›¾ç‰‡</h3>
                <div class="preview-upload-box" id="uploadBox">
                    <span style="font-size: 32px; color: #165DFF; margin-bottom: 12px;">ğŸ“</span>
                    <p style="font-size: 14px; color: #666;">
                        <div>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡ä¸Šä¼ </div>
                        <div><span class="number-text">ï¼ˆJPG/PNGï¼Œ</span>æœ€å¤§<span class="number-text">5MBï¼‰</span></div>
                    </p>
                    <input type="file" id="imageUpload" accept="image/*" style="display:none;">
                </div>
                <!-- é€‰æ‹©ç³»ç»Ÿå›¾ç‰‡ / ç®¡ç†å‘˜æ–°å¢ç³»ç»Ÿå…³å¡ -->
                <div class="preview-btn-row" style="margin-top: 12px; display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
                    <button id="pickSystemImageBtn" class="btn btn-secondary" type="button" onclick="openSystemImagePicker()">é€‰æ‹©ç³»ç»Ÿå›¾ç‰‡</button>
                </div>
                <!-- ç®¡ç†å‘˜åˆ›å»ºç³»ç»Ÿå…³å¡çš„è¡¨å•é¡¹ï¼ˆä»…ç®¡ç†å‘˜æ˜¾ç¤ºæäº¤æŒ‰é’®ï¼Œä½†å­—æ®µå¯¹æ‰€æœ‰äººå¯è§ä¹Ÿä¸å½±å“ï¼‰ -->
                <div class="input-item">
                    <label>å…³å¡æ ‡é¢˜</label>
                    <input id="adminTitleInput" type="text" placeholder="è¯·è¾“å…¥å…³å¡æ ‡é¢˜ï¼ˆ4-20ä¸ªå­—ç¬¦ï¼‰" maxlength="20">
                </div>
                <div class="input-item">
                    <label>ç±»å‹</label>
                    <select id="typeSelect">
                        <option value="nature">è‡ªç„¶é£å…‰</option>
                        <option value="animal">åŠ¨ç‰©</option>
                        <option value="building">å»ºç­‘</option>
                        <option value="cartoon">å¡é€š</option>
                        <option value="other" selected>å…¶ä»–</option>
                    </select>
                </div>
            </div>
            <div class="preview-card">
                <h3 style="font-size: 16px; margin-bottom: 16px;">æ‹¼å›¾é…ç½®</h3>
                <div class="input-item">
                    <label>æ‹¼å›¾å—æ•°</label>
                    <select id="difficultySelect">
                        <option value="3">3 x 3</option>
                        <option value="4" selected>4 x 4</option>
                        <option value="5">5 x 5</option>
                        <option value="6">6 x 6</option>
                        <option value="8">8 x 8</option>
                    </select>
                </div>
                <div class="input-item">
                    <label>å½¢çŠ¶</label>
                    <select id="shapeSelect">
                        <option value="square" selected>æ–¹å½¢</option>
                        <option value="triangle">ä¸‰è§’å½¢</option>
                          <option value="jigsaw">æ‹¼å›¾å—</option>
                    </select>
                </div>
                <!-- æ–°å¢çš„éšæœºé€‰é¡¹ -->
                <div class="random-options">
                    <div class="random-option-item">
                        <input type="checkbox" id="randomRotation" checked>
                        <label for="randomRotation">éšæœºæ—‹è½¬</label>
                    </div>
                    <div class="random-option-item">
                        <input type="checkbox" id="randomFlip" checked>
                        <label for="randomFlip">éšæœºç¿»è½¬</label>
                    </div>
                </div>
            </div>
        </div>
        <!-- å³ä¾§ï¼šé¢„è§ˆåŒº -->
        <div class="preview-right">
            <div class="preview-card">
                <h3 style="font-size: 16px; margin-bottom: 16px;">æ‹¼å›¾é¢„è§ˆ</h3>
                <div class="preview-img-box" id="previewImgBox">
                    <img id="previewImage" class="preview-img" src="" alt="é¢„è§ˆå›¾" style="display:none;">
                    <canvas id="gridCanvas" class="preview-grid-canvas" style="display:none;"></canvas>
                    <p id="previewTip" style="color:#666;">ä¸Šä¼ å›¾ç‰‡å¹¶é€‰æ‹©å—æ•°åé¢„è§ˆæ•ˆæœ</p>
                </div>
                <div style="margin-top: 16px; text-align: right;">
                    <p style="font-size: 14px; color: #666;">é¢„è®¡éš¾åº¦ï¼š<span id="difficultyText">ç®€å•</span></p>
                </div>
                <div class="preview-btn-row" style="display:flex; flex-direction:column; gap:12px; align-items:center;">
                    <button id="createPuzzleBtn" class="btn btn-primary" disabled>åˆ›å»ºæ‹¼å›¾</button>
                    <button id="adminAddSystemBtn" class="btn btn-primary" type="button" style="display:none;">æ–°å¢ç³»ç»Ÿå…³å¡</button>

                     
                </div>
            </div>
        </div>
    </div>
<!-- åœ¨ç°æœ‰æ¨¡æ€æ¡†åé¢æ·»åŠ åˆ†äº«æ¨¡æ€æ¡† -->
<div class="modal-mask" id="shareModal" style="display: none;">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <span>ä¿å­˜åˆ°åˆ†äº«</span>
            <span class="modal-close" onclick="document.getElementById('shareModal').style.display='none'">Ã—</span>
        </div>
        <div class="modal-body">
            <div class="input-item">
                <label for="puzzleTitle">å…³å¡åç§°</label>
                <input type="text" id="puzzleTitle" placeholder="è¯·è¾“å…¥å…³å¡åç§°ï¼ˆ5-20ä¸ªå­—ç¬¦ï¼‰">
                <p id="titleError" style="color: #ff4d4f; font-size: 12px; margin-top: 4px; display: none;">
                    å…³å¡åç§°é•¿åº¦éœ€åœ¨5~20ä¸ªå­—ç¬¦ä¹‹é—´
                </p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="document.getElementById('shareModal').style.display='none'">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="confirmShareBtn">ç¡®è®¤åˆ†äº«</button>
        </div>
    </div>
</div>
    <script>
        // æ ¹æ®æ¥å£æ–‡æ¡£ï¼šä¼˜å…ˆ /auth/is_adminï¼Œå¤±è´¥é€€å› /auth/meï¼Œå†å…œåº• userId===1
        async function fetchIsAdmin() {
            const token = localStorage.getItem('puzzleToken');
            if (!token) return false;
            try {
                // é¦–é€‰ /auth/is_admin
                let r = await fetch('/auth/is_admin', { headers: { Authorization: `Bearer ${token}` } });
                if (r && r.ok) {
                    const j = await r.json();
                    return !!(j && (j.code === 200 || j.code === '200') && j.data && j.data.isAdmin === true);
                }
                // å¤‡é€‰ /auth/me
                r = await fetch('/auth/me', { headers: { Authorization: `Bearer ${token}` } });
                if (r && r.ok) {
                    const j = await r.json();
                    return !!(j && (j.code === 200 || j.code === '200') && j.data && j.data.isAdmin === true);
                }
            } catch (_) {}
            // UI å…œåº•ï¼ˆä¸å½±å“åç«¯æƒé™æ ¡éªŒï¼‰
            return localStorage.getItem('puzzleUserId') === '1';
        }

        async function initEditorAdminUi() {
            const isAdmin = await fetchIsAdmin();
            const adminBtn = document.getElementById('adminAddSystemBtn');
            if (adminBtn) {
                if (isAdmin) {
                    adminBtn.style.setProperty('display', 'inline-flex', 'important');
                } else {
                    adminBtn.style.setProperty('display', 'none', 'important');
                }
            }

            const pickBtn = document.getElementById('pickSystemImageBtn');
            if (pickBtn) {
                // æ•è·é˜¶æ®µç»‘å®šï¼Œé¿å…è¢«å…¶ä»–è„šæœ¬æ‹¦æˆª
                pickBtn.removeEventListener('click', openSystemImagePicker, true);
                pickBtn.addEventListener('click', openSystemImagePicker, { capture: true });
            }

            if (adminBtn) {
                adminBtn.addEventListener('click', submitAdminSystemLevel);
            }
        }

        // å¢åŠ é‡è¯•ï¼Œé¿å…åˆ·æ–°ç¬é—´å› é‰´æƒ/æ—¶åºå¯¼è‡´æŒ‰é’®æœªæ˜¾ç¤º
        async function initEditorAdminUiWithRetry(maxTry = 20, delayMs = 500) {
            for (let i = 0; i < maxTry; i++) {
                await initEditorAdminUi();
                const btn = document.getElementById('adminAddSystemBtn');
                if (btn && btn.style.display !== 'none') return;
                await new Promise(r => setTimeout(r, delayMs));
            }
        }

        // æ‰“å¼€ç³»ç»Ÿå›¾ç‰‡é€‰æ‹©å™¨ï¼šè°ƒç”¨ /pic/levels/system
        async function openSystemImagePicker() {
            console.log('openSystemImagePicker called');
            try {
                const r = await fetch('/pic/levels/system');
                const j = await r.json();
                if (!(j && j.code === 200)) throw new Error('åŠ è½½ç³»ç»Ÿå›¾ç‰‡å¤±è´¥');
                const list = Array.isArray(j.data) ? j.data : [];
                ensureSystemImageModal();
                const modal = document.getElementById('systemImageModal');
                const grid = document.getElementById('systemImageGrid');
                if (!list.length) {
                    grid.innerHTML = '<div style="color:#B8BCC8; text-align:center; grid-column:1/-1;">æš‚æ— ç³»ç»Ÿå›¾ç‰‡</div>';
                    modal.style.display = 'flex';
                    return;
                }
                grid.innerHTML = list.map(item => `
                    <div class="card" style="background:#20223A; padding:8px; cursor:pointer;">
                        <img src="${item.image_url}" alt="${item.title||''}" style="width:100%; height:100px; object-fit:cover; border-radius:4px;">
                        <div style="font-size:12px; color:#E5E7EB; margin-top:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${item.title||''}</div>
                    </div>
                `).join('');
                modal.style.display = 'flex';
                grid.querySelectorAll('div.card').forEach((card, idx) => {
                    card.addEventListener('click', () => {
                        const chosen = list[idx];
                        if (chosen && chosen.image_url) {
                            imgData = chosen.image_url;
                            previewImage.src = imgData;
                            previewImage.style.display = 'block';
                            gridCanvas.style.display = 'block';
                            previewTip.style.display = 'none';
                            drawGrid();
                            createPuzzleBtn.disabled = false;
                        }
                        modal.style.display = 'none';
                    });
                });
            } catch (e) {
                alert('åŠ è½½ç³»ç»Ÿå›¾ç‰‡å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        function ensureSystemImageModal() {
            if (document.getElementById('systemImageModal')) return;
            const wrap = document.createElement('div');
            wrap.id = 'systemImageModal';
            wrap.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; z-index:2000;';
            wrap.innerHTML = `
                <div style="width:90%; max-width:720px; background:#20223A; border:1px solid #333; box-shadow:0 10px 30px rgba(0,0,0,0.5); padding:16px; border-radius:8px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <div style="color:#F9E078; font-size:16px;">é€‰æ‹©ç³»ç»Ÿå›¾ç‰‡</div>
                        <button id="systemImageClose" class="btn btn-secondary" type="button">å…³é—­</button>
                    </div>
                    <div id="systemImageGrid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:12px;"></div>
                </div>`;
            document.body.appendChild(wrap);
            document.getElementById('systemImageClose').addEventListener('click', () => {
                wrap.style.display = 'none';
            });
        }

        // ç®¡ç†å‘˜æäº¤ç³»ç»Ÿå…³å¡
        async function submitAdminSystemLevel() {
            try {
                const token = localStorage.getItem('puzzleToken');
                if (!token) { alert('è¯·å…ˆç™»å½•'); return; }
                const title = (document.getElementById('adminTitleInput').value||'').trim();
                const type = document.getElementById('typeSelect').value;
                const pieceCount = parseInt(difficultySelect.value, 10);
                // å½¢çŠ¶æ˜ å°„ï¼šsquare->rect, triangle->triangle, jigsaw->irregular
                const shapeMap = { square: 'rect', triangle: 'triangle', jigsaw: 'irregular' };
                const pieceShape = shapeMap[shapeSelect.value] || 'rect';
                const isRotatable = document.getElementById('randomRotation').checked ? 1 : 0;
                const isFlipable = document.getElementById('randomFlip').checked ? 1 : 0;

                if (!title || title.length < 4 || title.length > 20) {
                    alert('å…³å¡æ ‡é¢˜é•¿åº¦éœ€åœ¨4~20ä¸ªå­—ç¬¦ä¹‹é—´');
                    return;
                }
                if (!imgData) {
                    alert('è¯·å…ˆé€‰æ‹©æˆ–ä¸Šä¼ å›¾ç‰‡');
                    return;
                }

                // å°†é¢„è§ˆå›¾ç‰‡è½¬ä¸º Blobï¼ˆè‹¥æ˜¯æœ¬åœ°ä¸Šä¼ å¾—åˆ°çš„dataURLï¼›è‹¥æ˜¯ç³»ç»Ÿå›¾ç‰‡URLï¼Œåˆ™ç›´æ¥æ‹‰å–å¹¶è½¬ä¸ºBlobï¼‰
                let imageBlob;
                if (imgData.startsWith('data:')) {
                    const res = await fetch(imgData);
                    imageBlob = await res.blob();
                } else {
                    const res = await fetch(imgData, { mode: 'cors' });
                    imageBlob = await res.blob();
                }

                const form = new FormData();
                form.append('title', title);
                form.append('image', imageBlob, 'system-level.png');
                form.append('difficulty', pieceCount <= 4 ? 'easy' : (pieceCount <= 6 ? 'medium' : 'hard'));
                form.append('piece_count', String(pieceCount));
                form.append('piece_shape', pieceShape);
                form.append('is_rotatable', String(isRotatable));
                form.append('is_flipable', String(isFlipable));
                form.append('is_system_level', '1');
                form.append('type', type);

                const r = await fetch('/pic/puzzles', {
                    method: 'POST',
                    headers: { Authorization: `Bearer ${token}` },
                    body: form
                });
                const j = await r.json();
                if (j && (j.code === 200 || j.code === '200')) {
                    alert('ç³»ç»Ÿå…³å¡åˆ›å»ºæˆåŠŸ');
                    // åˆ·æ–°ç³»ç»Ÿå›¾ç‰‡æ•°æ®æºï¼Œä¾¿äºâ€œé€‰æ‹©ç³»ç»Ÿå›¾ç‰‡â€ç«‹åˆ»çœ‹åˆ°æ–°å›¾
                    await prefetchSystemImages();
                    // å†™å…¥æ–°å…³å¡IDï¼Œä¾¿äºåç»­ä¿å­˜è¿›åº¦
                    if (j.data && j.data.puzzle_id) {
                        localStorage.setItem('puzzleId', String(j.data.puzzle_id));
                        localStorage.setItem('isSystemLevel', 'true');
                    }
                } else {
                    alert(j?.message || 'åˆ›å»ºå¤±è´¥');
                }
            } catch (e) {
                alert('æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // é¢„æ‹‰ç³»ç»Ÿå›¾ç‰‡æ•°æ®ï¼Œä¾›â€œé€‰æ‹©ç³»ç»Ÿå›¾ç‰‡â€ç«‹å³ä½¿ç”¨
        let cachedSystemImages = [];
        async function prefetchSystemImages() {
            try {
                const r = await fetch('/pic/levels/system');
                const j = await r.json();
                if (j && j.code === 200) cachedSystemImages = j.data || [];
            } catch(e) {}
        }
        const uploadBox = document.getElementById('uploadBox');
        const imageUpload = document.getElementById('imageUpload');
        const previewImage = document.getElementById('previewImage');
        const gridCanvas = document.getElementById('gridCanvas');
        const difficultySelect = document.getElementById('difficultySelect');
        const createPuzzleBtn = document.getElementById('createPuzzleBtn');
        const previewTip = document.getElementById('previewTip');
        const difficultyText = document.getElementById('difficultyText');
        const shapeSelect = document.getElementById('shapeSelect');
        // è·å–æ–°å¢çš„å¤é€‰æ¡†å…ƒç´ 
        const randomRotationCheckbox = document.getElementById('randomRotation');
        const randomFlipCheckbox = document.getElementById('randomFlip');

        let imgData = null;
        let currentShape = 'square';

        uploadBox.onclick = () => imageUpload.click();
        uploadBox.addEventListener('dragover', e => { e.preventDefault(); uploadBox.style.borderColor = "#165DFF"; });
        uploadBox.addEventListener('dragleave', e => { e.preventDefault(); uploadBox.style.borderColor = "#E5E7EB"; });
        uploadBox.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadBox.style.borderColor = "#E5E7EB";
            if (e.dataTransfer.files.length > 0) {
                imageUpload.files = e.dataTransfer.files;
                handleImage();
            }
        });
        imageUpload.addEventListener('change', handleImage);

        function handleImage() {
            if (imageUpload.files.length > 0) {
                const file = imageUpload.files[0];
                if (file.size > 5 * 1024 * 1024) {
                    alert('å›¾ç‰‡å¤ªå¤§ï¼Œè¯·é€‰æ‹©å°äº5MBçš„å›¾ç‰‡');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    imgData = e.target.result;
                    previewImage.src = imgData;
                    previewImage.style.display = 'block';
                    gridCanvas.style.display = 'block';
                    previewTip.style.display = 'none';
                    drawGrid();

                    createPuzzleBtn.disabled = false;

                    createPuzzleBtn.disabled = false;
                    createPuzzleBtn.disabled = false;

                };
                reader.readAsDataURL(file);
            }
        }

        function updateDifficultyText() {
            const grid = parseInt(difficultySelect.value, 10); // 3/4/5/6/8
            const shape = shapeSelect.value; // square/triangle/jigsaw
            const rot = randomRotationCheckbox.checked;
            const flip = randomFlipCheckbox.checked;

            // è¯„åˆ†è§„åˆ™ï¼ˆå¯è°ƒï¼‰ï¼šå—æ•°æƒé‡æœ€é«˜ï¼Œå…¶æ¬¡å½¢çŠ¶ï¼Œå†æ¬¡æ—‹è½¬/ç¿»è½¬
            let score = 0;
            // å—æ•°ï¼ˆ3/4/5/6/8ï¼‰
            if (grid <= 3) score += 1;       // 9å—
            else if (grid === 4) score += 2; // 16å—
            else if (grid === 5) score += 3; // 25å—
            else if (grid === 6) score += 4; // 36å—
            else if (grid >= 8) score += 5;  // 64å—

            // å½¢çŠ¶ï¼šsquare(æ–¹å½¢)æœ€æ˜“ï¼Œtriangle æ¬¡ä¹‹ï¼Œjigsaw(æ‹¼å›¾å—/ä¸è§„åˆ™)æœ€éš¾
            if (shape === 'triangle') score += 1;
            else if (shape === 'jigsaw') score += 2;

            // æ—‹è½¬/ç¿»è½¬å¢åŠ éš¾åº¦
            if (rot) score += 1;
            if (flip) score += 1;

            // åˆ†æ®µæ˜ å°„åˆ°æ–‡æœ¬
            let txt = 'ç®€å•';
            if (score >= 3 && score <= 4) txt = 'ä¸­ç­‰';
            else if (score >= 5 && score <= 6) txt = 'å›°éš¾';
            else if (score >= 7) txt = 'æéš¾';
            difficultyText.textContent = txt;
        }
        difficultySelect.addEventListener('change', () => {
            drawGrid();
            updateDifficultyText();
        });
        updateDifficultyText();

        shapeSelect.addEventListener('change', () => {
            currentShape = shapeSelect.value;
            drawGrid();
            updateDifficultyText();
        });

        // éšæœºæ—‹è½¬/ç¿»è½¬å½±å“éš¾åº¦
        randomRotationCheckbox.addEventListener('change', updateDifficultyText);
        randomFlipCheckbox.addEventListener('change', updateDifficultyText);

        function drawGrid() {
            if (!imgData) return;
            previewImage.onload = function() {
                gridCanvas.width = previewImage.width;
                gridCanvas.height = previewImage.height;
                gridCanvas.style.width = previewImage.width + 'px';
                gridCanvas.style.height = previewImage.height + 'px';
                const ctx = gridCanvas.getContext('2d');
                ctx.clearRect(0, 0, gridCanvas.width, gridCanvas.height);
                ctx.strokeStyle = "#FFFFFF";
                ctx.lineWidth = 2;
                const grid = parseInt(difficultySelect.value);
                currentShape = shapeSelect.value;
                for (let i = 1; i < grid; i++) {
                    let x = i * gridCanvas.width / grid;
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, gridCanvas.height);
                    ctx.stroke();
                }
                for (let i = 1; i < grid; i++) {
                    let y = i * gridCanvas.height / grid;
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(gridCanvas.width, y);
                    ctx.stroke();
                }
                if (currentShape === 'triangle') {
                    for (let i = 0; i < grid; i++) {
                        for (let j = 0; j < grid; j++) {
                            const x = j * gridCanvas.width / grid;
                            const y = i * gridCanvas.height / grid;
                            const nextX = (j + 1) * gridCanvas.width / grid;
                            const nextY = (i + 1) * gridCanvas.height / grid;
                            if ((i % 2 === 0 && j % 2 === 0) || (i % 2 === 1 && j % 2 === 1)) {
                                ctx.beginPath();
                                ctx.moveTo(x, y);
                                ctx.lineTo(nextX, nextY);
                                ctx.stroke();
                            } else {
                                ctx.beginPath();
                                ctx.moveTo(nextX, y);
                                ctx.lineTo(x, nextY);
                                ctx.stroke();
                            }
                        }
                    }
                }
            };
            previewImage.src = imgData;
        }


        createPuzzleBtn.addEventListener('click', onCreatePuzzle);
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ç®¡ç†å‘˜æŒ‰é’®ï¼ˆå¸¦é‡è¯•ï¼‰ã€å¹¶åœ¨å¯è§æ—¶/é‰´æƒå°±ç»ªæ—¶å†é‡è¯•
        document.addEventListener('DOMContentLoaded', function() {
            initEditorAdminUiWithRetry();
            
            // æ¢å¤ä¹‹å‰çš„è®¾ç½®
            const customImage = localStorage.getItem('customImage');
            const customSize = localStorage.getItem('customSize');
            const customShape = localStorage.getItem('customShape');
            const storedRandomRotation = localStorage.getItem('randomRotation');
            const storedRandomFlip = localStorage.getItem('randomFlip');

            if (customImage && customSize) {
                imgData = customImage;
                previewImage.src = imgData;
                previewImage.style.display = 'block';
                gridCanvas.style.display = 'block';
                previewTip.style.display = 'none';
                difficultySelect.value = customSize;
                if (customShape) { 
                    shapeSelect.value = customShape; 
                    currentShape = customShape; 
                }
                if (storedRandomRotation !== null) {
                    randomRotationCheckbox.checked = storedRandomRotation === 'true';
                }
                if (storedRandomFlip !== null) {
                    randomFlipCheckbox.checked = storedRandomFlip === 'true';
                }
                updateDifficultyText();
                drawGrid();
                createPuzzleBtn.disabled = false;
                localStorage.removeItem('customImage');
                localStorage.removeItem('customSize');
                localStorage.removeItem('customShape');
                localStorage.removeItem('randomRotation');
                localStorage.removeItem('randomFlip');
            }
            
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) initEditorAdminUiWithRetry();
            });
            window.addEventListener('authready', () => initEditorAdminUiWithRetry());
            window.addEventListener('storage', (e) => {
                if (e.key === 'puzzleToken' && e.newValue) initEditorAdminUiWithRetry();
            });
        });



        // åˆ›å»ºæ‹¼å›¾ï¼šä»…åœ¨å‰ç«¯ä¿å­˜åˆ° localStorageï¼Œéšåå¼¹å‡ºâ€œä¸‹ä¸€æ­¥â€å¼¹çª—
        function onCreatePuzzle(){
            if (!imgData) { alert('è¯·å…ˆä¸Šä¼ æˆ–é€‰æ‹©å›¾ç‰‡'); return; }
            localStorage.setItem('customImage', imgData);
            localStorage.setItem('customSize', difficultySelect.value);
            localStorage.setItem('customShape', shapeSelect.value);
            localStorage.setItem('randomRotation', randomRotationCheckbox.checked);
            localStorage.setItem('randomFlip', randomFlipCheckbox.checked);
            // è‡ªå®šä¹‰å…³å¡è‹¥éœ€è¦ä¿å­˜è¿›åº¦ï¼Œè¿™é‡Œå¯ä»¥å…ˆåˆ›å»ºå…³å¡ï¼Œæ‹¿åˆ° puzzle_idã€‚
            // å¦‚ä»…ç•…ç©ä¸å­˜æ¡£ï¼Œå¯ç”Ÿæˆä¸€ä¸ªæœ¬åœ°IDï¼Œä¾›åç»­ä½¿ç”¨ï¼ˆä¸ä¼šå†™æ•°æ®åº“ï¼‰ã€‚
            if (!localStorage.getItem('puzzleId')) {
                const localId = 'custom:' + Date.now();
                localStorage.setItem('puzzleId', localId);
                localStorage.setItem('isSystemLevel', 'false');
            }
            ensureNextStepModal();
            document.getElementById('nextStepModal').style.display = 'flex';
        }

        // åˆ›å»ºå®Œæˆåçš„ä¸‹ä¸€æ­¥å¼¹çª—ï¼ˆå¼€å§‹æ¸¸æˆ / å»åˆ†äº«ï¼‰
        function ensureNextStepModal(){
            if (document.getElementById('nextStepModal')) return;
            const wrap = document.createElement('div');
            wrap.id = 'nextStepModal';
            wrap.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; z-index:2100;';
            wrap.innerHTML = `
                <div style="width:88%; max-width:520px; background:#20223A; border:1px solid #333; box-shadow:0 10px 30px rgba(0,0,0,0.5); padding:20px; border-radius:8px; text-align:center;">
                    <div style="color:#F9E078; font-size:16px; margin-bottom:12px;">æ‹¼å›¾å·²åˆ›å»º</div>
                    <div style="color:#E5E7EB; font-size:13px; margin-bottom:18px;">æ¥ä¸‹æ¥ä½ æƒ³è¦ï¼Ÿ</div>
                    <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
                        <button id="goPlayBtn" class="btn btn-primary">å¼€å§‹æ¸¸æˆ</button>
                        <button id="goShareBtn" class="btn btn-secondary">å»åˆ†äº«</button>
                        <button id="closeNextStepBtn" class="btn btn-secondary">å…³é—­</button>
                    </div>
                </div>`;
            document.body.appendChild(wrap);
            document.getElementById('goPlayBtn').addEventListener('click', () => {
                window.location.href = '{{ url_for('game_page') }}';
            });
            document.getElementById('goShareBtn').addEventListener('click', () => {
                wrap.style.display = 'none';
                // ç›´æ¥å¼€å§‹åˆ†äº«æµç¨‹ï¼Œä¸éœ€è¦é¢å¤–çš„è¾“å…¥æ¡†
                handleShareSubmit();
            });
            document.getElementById('closeNextStepBtn').addEventListener('click', () => {
                wrap.style.display = 'none';
            });
        }

        // åˆ†äº«åŠŸèƒ½
        function handleShareSuccess(shareData) {
            // åˆ›å»ºåˆ†äº«æˆåŠŸæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'modal-mask';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <span>åˆ†äº«æˆåŠŸï¼</span>
                        <span class="modal-close" onclick="this.closest('.modal-mask').remove()">Ã—</span>
                    </div>
                    <div class="modal-body" style="text-align: center;">
                        <p>æ‚¨çš„æ‹¼å›¾å·²æˆåŠŸåˆ†äº«</p>
                        <p> </p>
                        <p class="share_code">åˆ†äº«ç : <strong>${shareData.share_code}</strong></p>
                        <div style="display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
                            <button id="viewShareBtn" class="btn btn-primary">
                                å»æŸ¥çœ‹
                            </button>
                            <button id="continueGameBtn" class="btn btn-secondary">
                                ç»§ç»­æ¸¸æˆ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);

            document.getElementById('viewShareBtn').addEventListener('click', () => {
                window.location.href = '/share?tab=myShares';
                modal.remove();
            });

            document.getElementById('continueGameBtn').addEventListener('click', () => {
                localStorage.setItem('customImage', imgData);
                localStorage.setItem('customSize', difficultySelect.value);
                localStorage.setItem('customShape', shapeSelect.value);
                localStorage.setItem('randomRotation', randomRotationCheckbox.checked);
                localStorage.setItem('randomFlip', randomFlipCheckbox.checked);
                window.location.href = '{{ url_for('game_page') }}';
                modal.remove();
            });
        }


        // åˆ†äº«æäº¤å¤„ç†å‡½æ•°
        async function handleShareSubmit() {
            // è·å–å…³å¡æ ‡é¢˜ï¼Œä¼˜å…ˆä½¿ç”¨ç®¡ç†å‘˜è¾“å…¥æ¡†çš„å€¼
            const adminTitle = document.getElementById('adminTitleInput').value.trim();
            const title = adminTitle || 'æˆ‘çš„è‡ªå®šä¹‰æ‹¼å›¾';

            // éªŒè¯æ ‡é¢˜é•¿åº¦
            if (title.length < 5 || title.length > 20) {
                alert('å…³å¡åç§°é•¿åº¦éœ€åœ¨5~20ä¸ªå­—ç¬¦ä¹‹é—´');
                return;
            }

            try {
                // è·å–ç”¨æˆ·token
                const token = localStorage.getItem('puzzleToken');
                if (!token) {
                    alert('è¯·å…ˆç™»å½•æ‰èƒ½åˆ†äº«');
                    window.location.href = '/';
                    return;
                }

                // 1. åˆ›å»ºå…³å¡
                const formData = new FormData();
                formData.append('title', title);
                formData.append('difficulty', difficultyText.textContent === 'ç®€å•' ? 'easy' : difficultyText.textContent === 'ä¸­ç­‰' ? 'medium' : 'hard');
                formData.append('piece_count', difficultySelect.value * difficultySelect.value);
                // å½¢çŠ¶æ˜ å°„ï¼šsquare->rect, triangle->triangle, jigsaw->irregular
                const shapeMap = { square: 'rect', triangle: 'triangle', jigsaw: 'irregular' };
                formData.append('piece_shape', shapeMap[shapeSelect.value]);
                formData.append('is_rotatable', randomRotationCheckbox.checked ? 1 : 0);
                formData.append('is_system_level', 0);
                difficultySelect
                // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶åå‡½æ•°
                function generateUniqueFileName() {
                    const timestamp = new Date().getTime();
                    const randomString = Math.random().toString(36).substring(2, 10);
                    return `puzzle_${timestamp}_${randomString}.png`;
                }

                // å°†base64å›¾ç‰‡è½¬æ¢ä¸ºBlobå¯¹è±¡
                const blob = await fetch(imgData).then(res => res.blob());
                const uniqueFileName = generateUniqueFileName();
                formData.append('image', blob, uniqueFileName);

                // è°ƒç”¨åˆ›å»ºå…³å¡æ¥å£
                const createResponse = await fetch('/pic/puzzles', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                // å¤„ç†å¯èƒ½çš„401æœªæˆæƒé”™è¯¯
                if (createResponse.status === 401) {
                    localStorage.removeItem('puzzleToken');
                    localStorage.removeItem('userId');
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    window.location.href = '/';
                    return;
                }

                const createResult = await createResponse.json();

                if (createResult.code !== '200') {
                    throw new Error(`åˆ›å»ºå…³å¡å¤±è´¥: ${createResult.message}`);
                }

                // 2. åˆ›å»ºåˆ†äº«è®°å½•
                const puzzleId = createResult.data.puzzle_id;
                console.log('puzzleId:', puzzleId, 'type:', typeof puzzleId);
                const shareResponse = await fetch('/share/shares', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        puzzle_id: puzzleId,
                    })
                });

                // å†æ¬¡æ£€æŸ¥401é”™è¯¯
                if (shareResponse.status === 401) {
                    localStorage.removeItem('puzzleToken');
                    localStorage.removeItem('userId');
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    window.location.href = '/';
                    return;
                }

                // å¤„ç†æ‰€æœ‰é200å“åº”
                if (!shareResponse.ok) {
                    const errorText = await shareResponse.text();
                    throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${shareResponse.status} - ${errorText}`);
                }

                    // å¤„ç†æˆåŠŸå“åº”
                    const shareResult = await shareResponse.json();
                    if (shareResult.code === '200') {
                        handleShareSuccess(shareResult.data);
                    } else {
                        throw new Error(`åˆ†äº«å¤±è´¥: ${shareResult.message}`);
                    }

            } catch (error) {
                console.error('åˆ†äº«å¤±è´¥:', error);
                alert(`åˆ†äº«å¤±è´¥: ${error.message}`);
            }
        }
    </script>


<!-- å¸®åŠ©é¡µé¢æ¨¡æ€æ¡† -->
<div class="modal-mask" id="helpModal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <span>æ“ä½œæŒ‡å—</span>
            <span class="modal-close" onclick="document.getElementById('helpModal').style.display='none'">Ã—</span>
        </div>
        <div class="modal-body" style="font-size: 14px; line-height: 24px; color: #E0E0E0;">
            <p><strong style="color: #F9E078;">1. æ¸¸æˆæ“ä½œ</strong></p>
            <p>- é¼ æ ‡å·¦é”®é•¿æŒ‰å›¾å—ï¼Œæ‹–æ‹½åˆ°æ‹¼å›¾åŒºåŸŸ</p>
            <p>- å•å‡»é€‰ä¸­çš„å›¾å—ï¼Œé¡ºæ—¶é’ˆæ—‹è½¬90åº¦</p>
            <p>- ç‚¹å‡»"æ’¤é”€"å¯è¿˜åŸä¸Šä¸€æ­¥æ“ä½œï¼Œ"é‡åš"æ¢å¤æ’¤é”€æ“ä½œ</p>
            <p><strong style="color: #F9E078; margin-top: 16px; display: block;">2. è‡ªå®šä¹‰æ‹¼å›¾</strong></p>
            <p>- æ”¯æŒä¸Šä¼ æœ¬åœ°å›¾ç‰‡ï¼ˆJPG/PNGï¼Œæœ€å¤§5MBï¼‰ï¼Œå¯è£å‰ªè°ƒæ•´</p>
            <p>- å¯è®¾ç½®æ‹¼å›¾å—æ•°ï¼ˆ4-64å—ï¼‰ã€å½¢çŠ¶ï¼ˆçŸ©å½¢/å¼‚å½¢ï¼‰ã€æ˜¯å¦æ—‹è½¬</p>
            <p><strong style="color: #F9E078; margin-top: 16px; display: block;">3. å­˜æ¡£ä¸åˆ†äº«</strong></p>
            <p>- ç™»å½•ç”¨æˆ·å­˜æ¡£åŒæ­¥è‡³æœåŠ¡å™¨ï¼Œæ¸¸å®¢å­˜æ¡£ä»…ä¿å­˜åœ¨å½“å‰æµè§ˆå™¨</p>
            <p>- è‡ªå®šä¹‰æ‹¼å›¾å¯åˆ†äº«è‡³"åˆ†äº«ä¸­å¿ƒ"ï¼Œä¾›å…¶ä»–ç©å®¶æ¸¸ç©</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="document.getElementById('helpModal').style.display='none'">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>
</div>

    <!-- é¡µé¢ç‰¹å®šçš„èƒŒæ™¯éŸ³ä¹ -->
    <script>
        // ç­‰å¾…éŸ³ä¹ç®¡ç†å™¨åŠ è½½å®Œæˆ
        function initPageMusic() {
            if (window.musicManager) {
                // æ‹¼å›¾ç¼–è¾‘å™¨é¡µé¢è‡ªåŠ¨æ’­æ”¾ä¸»ç•Œé¢éŸ³ä¹
                window.musicManager.playScene('main');
            } else {
                // å¦‚æœéŸ³ä¹ç®¡ç†å™¨å°šæœªåŠ è½½ï¼Œç¨åé‡è¯•
                setTimeout(initPageMusic, 100);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåç›´æ¥åˆå§‹åŒ–éŸ³ä¹ï¼Œæ— éœ€ç­‰å¾…ç”¨æˆ·äº¤äº’
        document.addEventListener('DOMContentLoaded', function() {
            // ç›´æ¥å°è¯•æ’­æ”¾éŸ³ä¹
            initPageMusic();
        });
    </script>

<script>
// ç§»åŠ¨ç«¯è®¾å¤‡æ£€æµ‹å’Œç±»æ·»åŠ 
(function() {
    'use strict';
    
    function isMobile() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
               window.innerWidth <= 768;
    }
    
    function addMobileClass() {
        if (isMobile()) {
            document.body.classList.add('mobile-device');
        }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', addMobileClass);
    } else {
        addMobileClass();
    }
    
    // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°æ£€æµ‹
    window.addEventListener('resize', function() {
        setTimeout(addMobileClass, 100);
    });
})();
</script>

    </body>
</html>

